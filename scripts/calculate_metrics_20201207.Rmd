---
title: "calculate_metrics_20201207"
output: html_document
---

# Data prep 

```{r Load libs}
library(tidyverse)
library(mmir)

root.dir <- rprojroot::find_root("lgss.Rproj")
datamod.dir <- file.path("C:/Users/gmlemley/New York State Office of Information Technology Services/SMAS - Streams Data Modernization/Cleaned Files/FINAL_RELOADS_SEPT2020")

```

```{r Master taxa table prep}
# Load master taxa table
master.taxa <- read.csv(file.path(datamod.dir, "Final_Macro_ITS", "20201019_S_MSTR_MACRO_SPECIES.csv"), stringsAsFactors = FALSE, na.strings = c("", "NA")) %>% 
  rename_all(tolower) %>% 
  setNames(., sub("mms_", "", names(.)))

master.taxa.fill <- taxa_fill(master.taxa, .final_id = macro_genspecies, .prefix = "unidentified", kingdom:species) %>%
  mutate(ttaxa = species) %>%
  relocate(ttaxa) %>%
  rename(ffg = feeding_habits,
         tol_char = tolerance_name,
         tol_int = tolerance)

```

```{r Sample taxa table prep}

# Load bug matrix
taxa.df.wide <- read.csv(file.path(root.dir, "data/compile_2015-2019/bugs/2015-2019_lowgrad_bugs_matrix_UNIQUE_20201210.csv"), check.names = FALSE)

# List taxa names for troublshooting
# bugnames <- as.data.frame(names(taxa.df)) %>% 
#   rename(genspecies = "names(taxa.df)") %>% 
#   filter(!grepl("site_id", genspecies))

# Convert from wide to long
taxa.df <- taxa.df.wide %>% 
  gather(final_id, count, -site_id) %>% 
  filter(!is.na(count),
         count > 0)  

# Identify missing taxa
missing.df <- taxa.df %>% 
  select(final_id) %>% 
  distinct() %>% 
  anti_join(master.taxa, by = c("final_id" = "macro_genspecies"))

# Join attributes to data
taxa.df <- taxa.df %>% 
  rename(macro_genspecies = final_id) %>%
  left_join(master.taxa.fill, by = "macro_genspecies") #%>% 
  # fill_taxa(taxa.df, final_id, kingdom:subspecies)

# write.csv(taxa.df, "lowgrad_taxa_zach.csv")

rm(master.taxa, missing.df, taxa.df.wide)
```

```{r Create nested dataframe}
nest.df <- taxa.df %>%
  group_nest(site_id, .key = "data")

```

# Calculate metrics

```{r Tolerance Metric (HBI)}

# Spot-check: not completed

taxa_tol.df <- nest.df %>%
  mutate(
    hbi_taxa_tol = taxa_tol_index(.dataframe = .,
                                    .key_col = site_id,
                                    .counts_col = count,
                                    .tol_col = tol_int,
                                    .unnest_col = data)
  ) %>% 
  select(-data)

```



## Richness Metrics

```{r Standard Richness}

# Spot check: OK

rich_std.df <- nest.df %>% 
  mutate(
    # Class level richness
    rich_class = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = class,
                            .unnest_col = data),
    # Order level richness
    rich_order = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = order,
                            .unnest_col = data),
    # Family level richness
    rich_family = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = family,
                            .unnest_col = data),
    # Genus level richness
    rich_genus = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = genus,
                            .unnest_col = data),
    # Target taxon level richness
    rich_ttaxa = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .unnest_col = data),
    # Functional Feeding group richness
    rich_ffg = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ffg,
                            .unnest_col = data,
                            .filter = !is.na(ffg)),
    # Tolerance value richness
    rich_tol = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = tol_char,
                            .unnest_col = data,
                            .filter = !is.na(tol_char))
  ) %>% 
  select(-data)

```

```{r Subgroup Richness}

# Spot-check: OK

rich_subgr.df <- nest.df %>%
  mutate(
    rich_ttaxa_ep = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                       "plecoptera"),
                            .unnest_col = data),
    rich_ttaxa_et = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                       "trichoptera"),
                            .unnest_col = data),
    rich_ttaxa_pt = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = order %in% c("plecoptera",
                                                       "trichoptera"),
                            .unnest_col = data),
    rich_ttaxa_ept = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                       "plecoptera",
                                                       "trichoptera"),
                            .unnest_col = data),
    # Zach said this is usually specific to lakes, but keep it. May be good for LG.
    rich_ttaxa_cote = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = order %in% c("coleoptera",
                                                  "odonata",
                                                  "trichoptera",
                                                  "ephemeroptera"),
                            .unnest_col = data),
    rich_ttaxa_cot = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = order %in% c("coleoptera",
                                                  "odonata",
                                                  "trichoptera"),
                            .unnest_col = data),
    # Below Metrics were in old LG metrics script
    rich_ttaxa_toe = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = order %in% c("trichoptera",
                                                   "odonata",
                                                   "ephemeroptera"),
                            .unnest_col = data),
    rich_ttaxa_potec = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = order %in% c("plecoptera",
                                                   "odonata",
                                                   "trichoptera",
                                                   "ephemeroptera",
                                                   "coleoptera"),
                            .unnest_col = data),
    rich_ttaxa_mol = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = phylum %in% "mollusca",
                            .unnest_col = data),
     # Already done in taxa_seq() chunk, but used to calculate subgr
    rich_ttaxa_amphi = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = order %in% "amphipoda",
                            .unnest_col = data),
    rich_ttaxa_mol_amph = rich_ttaxa_mol + rich_ttaxa_amphi,
    rich_ttaxa_crust = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = subphylum %in% "crustacea",
                            .unnest_col = data),
    rich_ttaxa_mol_crust = rich_ttaxa_crust + rich_ttaxa_mol,
    rich_ttaxa_chiro = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .filter = subfamily %in% "chironominae",
                            .unnest_col = data),
    # "oligochaeta" not present in master taxa table! How to subset worms? Needed?v1
    # rich_olig = taxa_rich(.dataframe = .,
    #                         .key_col = site_id,
    #                         .group_col = ttaxa,
    #                         .filter = subclass %in% "oligochaeta",
    #                         .unnest_col = data),
    # Richness of intolerant and facultative Taxa 
    rich_ttaxa_intol_facul = taxa_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = tol_int <=6,
                             .unnest_col = data)
  ) %>% 
  select(-data)

# rich_subgr.df %>%
#   mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()
```

```{r Percent Richness}

# Spot check: not completed

rich_pct.df <- nest.df %>% 
  mutate(
     pct_rich_ttaxa_ep = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = order %in% c("ephemeroptera", 
                                                    "plecoptera"),
                             .unnest_col = data),
     pct_rich_ttaxa_et = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = order %in% c("trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_rich_ttaxa_pt = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = order %in% c("trichoptera",
                                                    "plecoptera"),
                             .unnest_col = data), 
     pct_rich_ttaxa_ept = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = order %in% c("plecoptera",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_rich_ttaxa_toe = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = order %in% c("odonata",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_rich_ttaxa_cote = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = order %in% c("coleoptera",
                                                    "odonata",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data),
     pct_rich_ttaxa_cot = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = order %in% c("coleoptera",
                                                    "odonata",
                                                    "trichoptera"),
                             .unnest_col = data),
     pct_rich_ttaxa_potec = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = order %in% c("plecoptera",
                                                    "coleoptera",
                                                    "odonata",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_rich_ttaxa_mol = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = phylum %in% "mollusca",
                             .unnest_col = data), 
     pct_rich_ttaxa_crust = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = subphylum %in% "crustacea",
                             .unnest_col = data), 
     pct_rich_ttaxa_chiro = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = subfamily %in% "chironominae",
                             .unnest_col = data),
    # Percent Richness of Intolerant and Facultative Taxa
     pct_rich_ttaxa_intol_facul = taxa_pct_rich(.dataframe = .,
                             .key_col = site_id,
                             .group_col = ttaxa,
                             .filter = tol_int <=6,
                             .unnest_col = data)
  ) %>% 
  select(-data)

```


## Diversity Metrics

```{r Community Diversity}

### Not spot-checked

div.df <- nest.df %>%
  mutate(
    shannon_ttaxa = taxa_div(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .group_col = ttaxa,
                             .job = "shannon",
                             .base_log = 2,
                             .unnest_col = data),
    simpson_ttaxa = taxa_div(.dataframe = .,
                             .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .job = "simpson",
                            .unnest_col = data),
    margalef_ttaxa = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .job = "margalef",
                            .unnest_col = data),
    menhinick_ttaxa = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .job = "menhinick",
                            .unnest_col = data),
    pielou_ttaxa = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .job = "pielou",
                            .unnest_col = data),
  ) %>% 
  select(-data)

# div.df %>%
#   mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()
```

```{r Subgroup Diversity}

# Not spot-checked
# Changed group_col from order to ttaxa. Output differences were large.

div_subgr.df <- nest.df %>%
  mutate(
    gini_simpson_ttaxa_ept = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                   "plecoptera",
                                                   "trichoptera"),
                            .job = "gini_simpson",
                            .unnest_col = data),
    simpson_ttaxa_ept = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                   "plecoptera",
                                                   "trichoptera"),
                            .job = "simpson",
                            .unnest_col = data),
    # Simpson Diversity of Coleoptera, Odonata, and Trichoptera Genus-Species
    simpson_ttaxa_cot = taxa_div(.data = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "odonata",
                                                   "trichoptera"), 
                            .job = "simpson",
                            .unnest_col = data),
    shannon_ttaxa_ept = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                   "plecoptera",
                                                   "trichoptera"),
                            .job = "shannon",
                            .base_log = 2,
                            .unnest_col = data),
    # Shannon Diversity of Coleoptera, Odonata, and Trichoptera Genus-Species
    shannon_ttaxa_cot = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "odonata",
                                                   "trichoptera"), 
                            .job = "shannon",
                            .base_log = 2,
                            .unnest_col = data),    
    # Shannon Diversity of Intolerant and Facultative Taxa
    shannon_ttaxa_intol_facul = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = tol_int <=6,
                            .job = "shannon",
                            .base_log = 2,
                            .unnest_col = data)
  ) %>% 
  select(-data)

# div_subgr.df %>%
#   mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()
```

```{r Dominance}

### Not spot-checked

dom.df <- nest.df %>%
  mutate(
    dom_1_ttaxa = taxa_dom(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .dom_level = 1,
                            .unnest_col = data),
    dom_2_ttaxa = taxa_dom(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .dom_level = 2,
                            .unnest_col = data),
    dom_3_ttaxa = taxa_dom(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .dom_level = 3,
                            .unnest_col = data),
    dom_4_ttaxa = taxa_dom(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .dom_level = 4,
                            .unnest_col = data),
    dom_5_ttaxa = taxa_dom(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .dom_level = 5,
                            .unnest_col = data)
  ) %>% 
  select(-data)

# dom.df %>%
#   mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()
```


## Community Metrics

```{r Percentages}

# Spot-checked okay

pct.df <- nest.df %>% 
  mutate(
     pct_ep = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("ephemeroptera", 
                                                    "plecoptera"),
                             .unnest_col = data),
     pct_et = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_pt = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("trichoptera",
                                                    "plecoptera"),
                             .unnest_col = data), 
     pct_ept = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("plecoptera",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_toe = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("odonata",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_cote = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("coleoptera",
                                                    "odonata",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data),
     pct_cot = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("coleoptera",
                                                    "odonata",
                                                    "trichoptera"),
                             .unnest_col = data),
     pct_potec = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("plecoptera",
                                                    "coleoptera",
                                                    "odonata",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_mol = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = phylum %in% "mollusca",
                             .unnest_col = data), 
     pct_crust = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = subphylum %in% "crustacea",
                             .unnest_col = data), 
     pct_chiro = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = subfamily %in% "chironominae",
                             .unnest_col = data)
  ) %>% 
  select(-data)
# pct.df %>%
#   mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()

```


## Sequence Metrics

```{r}

seq.df <- nest.df %>%
  # Append all of the results as columns to a single DF.
  bind_cols(
    # Sequence through ttaxa for each unique column specified in the .filter_cols_vec.
    taxa_seq(.data = .,
             .key_col = site_id,
             # .counts_col = count,
             .filter_cols_vec = c("class",
                                  "order",
                                  "family",
                                  "tol_char",
                                  "ffg"),
             .group_col = ttaxa,
             .job = "rich",
             .exclude_pattern = "unidentified",
             .unnest_col = data),
    # Sequence through each unique column specified in the .filter_cols_vec 
    # to calculate ttaxa percent richness.
    taxa_seq(.data = .,
             .key_col = site_id,
             # .counts_col = count,
             .filter_cols_vec = c("class",
                                  "order",
                                  "family",
                                  "tol_char",
                                  "ffg"),
             .group_col = ttaxa,
             .job = "pct_rich",
             .exclude_pattern = "unidentified",
             .unnest_col = data),
    taxa_seq(.data = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class",
                                  "order",
                                  "suborder",
                                  "family",
                                  "genus",
                                  "tol_char",
                                  "ffg"),
             .job = "pct",
             .exclude_pattern = "unidentified",
             .unnest_col = data),
    # Spot-checked that manual pct_amphi came out the same as pct_NULL_amphipoda (produced by below)
    taxa_seq(.data = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class",
                                  "order", 
                                  "family",
                                  "tol_char",
                                  "ffg"),
             .group_col = ttaxa,
             .base_log = 2,
             .job = "shannon",
             .exclude_pattern = "unidentified",
             .unnest_col = data),
    taxa_seq(.data = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class",
                                  "order", 
                                  "family",
                                  "tol_char",
                                  "ffg"),
             .group_col = ttaxa,
             .job = "simpson",
             .exclude_pattern = "unidentified",
             .unnest_col = data)
  ) %>% 
  select(-data)

seq.names <- as.data.frame(names(seq.df))

```



## Combine metrics dataframes

```{r}
# metrics.all <- div_subgr.df %>%
#   left_join(div.df) %>% 
#   left_join(dom.df) %>% 
#   left_join(rich_std.df) %>% 
#   left_join(rich_pct.df) %>% 
#   left_join(pct.df) %>% 
#   left_join(rich_subgr.df) %>% 
#   left_join(taxa_tol.df) %>% 
#   left_join(seq.df)

# Cleaner way to join
metrics.df <- list(div_subgr.df,
                     div.df,
                     dom.df,
                     rich_std.df,
                     rich_pct.df,
                     pct.df,
                     rich_subgr.df,
                     taxa_tol.df,
                     seq.df) %>% 
  plyr::join_all(by = c("site_id"))

metrics.names <- names(metrics.df)
metrics.names.df <- as.data.frame(metrics.names, col.names = c("metrics", "x"))

# Look for dups
# metrics.dups <- metrics.names.df %>%
#   mutate(n = n()) %>%
#   group_by(metrics.names) %>%
#   filter(n>1)
# 
#   group_by(accession) %>%
#   mutate(n = n()) %>%
#   filter(n > 1)
# 
# metrics.dups %>% janitor::get_dupes(metrics.all)
# 
# # library(digest)
# test <- metrics.all[!duplicated(lapply(metrics.all, digest::digest))]


# Attach disturbance categories
condition <- read.csv(file.path("C:/Data/LGSS_scripting/lgss/data/compile_2015-2019/condition_classes", "2015-2019_LG_condclasses_20201216.csv"))
metrics.df <- metrics.df %>%
  left_join(., condition) %>% 
  select(site_id, condition_class, everything()) #%>% 
  # filter(!is.na(condition_class))

# Investigate certain metrics
# metrics.sub <- metrics.all %>% 
#   select(site_id, pct_amphi, pct_NULL_amphipoda)

```



## PMA calculation

Percent Model Affinity of Orders - (PMA-O) Is a measure of order level similarity to a model based
on the reference streams Novak and Bode (1992).

Calculation: Determine the percent composition for each major group - Coleoptera, Diptera,
Ephemeroptera, Plecoptera, Trichoptera, Oligochaeta, Other. Compare to the "Model" for the appropriate
stream community (see below), then add up the lower of the two values for each of the groups (assessment
site vs Model), this is the PMA-O for the assessment site. 

See https://apps.epscor.w3.uvm.edu/web/streams/PDFFiles/Manual_Calc_Of_Metrics.pdf for details

```{r, eval = TRUE}

  ##    Calculate the numbers below PMA calculation chunk below

##### Look at biomonitoring SOP to see which groups to use for Streams

metrics.df_PMA <- metrics.df %>% 
    mutate(PMA_diptera = 47.76484, PMA_clitellata = 9.610563, PMA_ephemeroptera = 4.494907, PMA_odonata = 2.20276, PMA_trichoptera = 2.589185, PMA_coleoptera = 2.301258, PMA_other =31.03648) %>% 
  group_by(site_id) %>% 
  mutate(pct_other = sum(pct_diptera, pct_clitellata, pct_ephemeroptera, pct_odonata, pct_trichoptera, pct_coleoptera)) %>% 
  mutate(pct_other= 100-pct_other) %>% 
  ungroup() %>% 
  mutate(PMA_value_diptera= case_when(
    PMA_diptera < pct_diptera ~ PMA_diptera,
    PMA_diptera > pct_diptera ~ pct_diptera,
  )) %>% 
  mutate(PMA_value_clitellata= case_when(
    PMA_clitellata < pct_clitellata ~ PMA_clitellata,
    PMA_clitellata > pct_clitellata ~ pct_clitellata,
  )) %>% 
  mutate(PMA_value_ephemeroptera= case_when(
    PMA_ephemeroptera < pct_ephemeroptera ~ PMA_ephemeroptera,
    PMA_ephemeroptera > pct_ephemeroptera ~ pct_ephemeroptera,
  )) %>% 
  mutate(PMA_value_odonata= case_when(
    PMA_odonata < pct_odonata ~ PMA_odonata,
    PMA_odonata > pct_odonata ~ pct_odonata,
  )) %>% 
  mutate(PMA_value_trichoptera= case_when(
    PMA_trichoptera < pct_trichoptera ~ PMA_trichoptera,
    PMA_trichoptera > pct_trichoptera ~ pct_trichoptera,
  )) %>% 
  mutate(PMA_value_coleoptera= case_when(
    PMA_coleoptera < pct_coleoptera ~ PMA_coleoptera,
    PMA_coleoptera > pct_coleoptera ~ pct_coleoptera,
  )) %>% 
  mutate(PMA_value_other= case_when(
    PMA_other < pct_other ~ PMA_other,
    PMA_other > pct_other ~ pct_other,
  )) %>% 
  group_by(site_id) %>% 
  mutate(PMA = sum(PMA_value_diptera, PMA_value_clitellata, PMA_value_coleoptera, PMA_value_ephemeroptera, PMA_value_odonata, PMA_value_trichoptera, PMA_value_other)) %>% 
  ungroup() %>% 
  select(-PMA_value_diptera, -PMA_value_clitellata, -PMA_value_coleoptera, -PMA_value_ephemeroptera, -PMA_value_odonata, -PMA_value_trichoptera, -PMA_value_other)

```



# Modeling and filtering


```{r Split into training dataset}

library(tidymodels)
## Q: Why 42?

set.seed(42)
train_test_split <- metrics.df %>% 
  # mutate(condition_class = factor(condition_class, levels = c("1","3","4","2"))) %>% 
  # filter(condition_class %in% c("1", "3")) %>%
  rsample::initial_split(strata = condition_class)

## Q: Why did matt change this to 1 and 3?
train.df <- training(train_test_split) %>% 
  filter(condition_class %in% c("1", "3")) 

## Q: Same as above (see commented below)
test.df <- testing(train_test_split)
# test.df <- testing(train_test_split) %>% 
#   filter(condition_class %in% c("1", "3"))
```

```{r PMA calculation}

### For use in above block?
### Determining percent composition of each major group for PMA calculation above???

train.df.PMA<-train.df %>% 
  filter(condition_class == "1") %>% 
  group_by(site_id) %>% 
  select(site_id, pct_diptera, pct_clitellata, pct_ephemeroptera, pct_odonata, pct_trichoptera, pct_coleoptera) %>% 
  mutate(other = sum(pct_diptera, pct_clitellata, pct_ephemeroptera, pct_odonata, pct_trichoptera, pct_coleoptera)) %>% 
  mutate(other= 100-other) %>% 
  ungroup() %>% 
  summarise_all(list(mean))

```


```{r Kolmogorov Mmirnov K-S Test, eval=FALSE}

### Probably not necessary because of even split we do above. 

## Kolmogorov Mmirnov K-S Test to ensure equal distribution of "condition" in training and calibration sets 
## Noted in Blocksom, 2009

### ADAPT FROM MATT'S SCRIPT
## Q: What is the target result here?

# PULL IN DATA and replace below
all_abiotic_classified <- read_csv(file.path("C:/Data/LGSS_scripting/lgss/data/compile_2015-2019/condition_classes",
                                             "2015-2019_LG_condclasses_20201216.csv")) %>%
  select(site_id, PC1)  

test.df.sites<-test.df %>% 
  select(uniqueid)
test.df.pc1<-left_join(test.df.sites, all_abiotic_classified, by=c("uniqueid"))

train.df.sites<-train.df %>% 
  select(uniqueid)
train.df.pc1<-left_join(train.df.sites, all_abiotic_classified, by=c("uniqueid"))


ks.test(train.df.pc1$PC1, test.df.pc1$PC1)

```


```{r Calculate Sensitivity and filter}

# For full dataset
long.df <- tidyr::pivot_longer(data = metrics.df,
                               cols = -c(site_id, condition_class),
                               names_to = "metric",
                               values_to = "value")
sens.df <- sensitivity(.dataframe = long.df,
                              .metric_col = metric,
                              .value_col = value,
                              .condition_col = condition_class,
                              .reference = "1",
                              .degraded = "3")

# For training dataset
long.train.df <- tidyr::pivot_longer(data = train.df,
                               cols = -c(site_id, condition_class),
                               names_to = "metric",
                               values_to = "value")
sens.train.df <- sensitivity(.dataframe = long.train.df,
                              .metric_col = metric,
                              .value_col = value,
                              .condition_col = condition_class,
                              .reference = "1",
                              .degraded = "3")

# From Matt's code...
sensitive_mets.vec <- sens.train.df %>% 
  filter(barbour >= 2) %>% 
  # filter(de >= 50) %>%
  pull(metric)

train_sensitive.df <- train.df %>% 
  select(condition_class, all_of(sensitive_mets.vec)) %>% 
  mutate(condition_class = as.character(condition_class))

# Creating cross-validation set. Comes into play later during validation set (logistic regression model- calculate probability for if site is impaired)
train_10cv.df <- train_sensitive.df %>% 
  rsample::vfold_cv(v = 10, repeats = 1, strata = condition_class)
```

```{r Look at metrics correlations}

## No point in looking at these until end. Use at end to further filter (remove redundant metrics). Flag any >0.75 (found in lit; Blocksom 2009).
sensitivity.df.subset<-train.df %>% 
  select(site_id, condition_class, all_of(sensitive_mets.vec))

sensitivity.df.rank<-sensitivity.df %>% 
  unite("rank",metric, barbour, de, disturbance, sep = "_", remove = FALSE) %>% 
  select(rank, metric)

sensitivity.df.subset.long<-sensitivity.df.subset %>% 
  select(-condition_class) %>% 
  pivot_longer(!site_id, names_to = "metric", values_to="value")

sensitivity.df.subset.long<-left_join(sensitivity.df.subset.long, sensitivity.df.rank, by=c("metric"))

sensitivity.df.subset.wide<-sensitivity.df.subset.long %>% 
  select(-metric) %>% 
  rename(metric=rank) %>% 
  pivot_wider(names_from = metric, values_from = value)


correlations<-sensitivity.df.subset %>% 
  select(-condition_class, -site_id) %>% 
  corrr::correlate(use = "pairwise.complete.obs", method = "spearman") %>% 
  corrr::rearrange() %>% 
  corrr::shave() 

correlations %>% 
  corrr::rplot()
```

```{r Various metric stats}

# Use this to ones with bad ranges. Remove pct metrics <10, richness <5, div <1
sensitivity.df.subset.range<-sensitivity.df.subset %>%
  select(-condition_class) %>% 
  summarise_at(vars(-site_id), range) %>%
  rownames_to_column() %>%
  rename(summary_stat=rowname) %>% 
   mutate(summary_stat = case_when(
     summary_stat== 1 ~ "min",
     summary_stat == 2  ~ "max"))

sensitivity.df.subset.mean<-sensitivity.df.subset %>%
  select(-condition_class) %>% 
  summarise_at(vars(-site_id), mean) %>%
  rownames_to_column() %>%
  rename(summary_stat=rowname) %>% 
   mutate(summary_stat = case_when(
     summary_stat== 1 ~ "mean"))


sensitivity.df.subset.IQR<-sensitivity.df.subset %>%
   filter(condition_class=="1") %>% 
  select(-condition_class) %>% 
  summarise_at(vars(-site_id), IQR) %>%
  rownames_to_column() %>%
  rename(summary_stat=rowname) %>% 
   mutate(summary_stat = case_when(
     summary_stat== 1 ~ "IQR"))
```



```{r >50% same values}
#Determine which metrics have >50% same values. These don't tell much about sample differences.

sensitivity.df.subset.long.round<-sensitivity.df.subset.long %>% 
  mutate(value = case_when(
    str_detect(metric, "rich_") ~ round(value, digits = 0),
    str_detect(metric, "pct_") ~ ceiling(value),
    str_detect(metric, "shannon_") ~ round(value, digits = 1),
    str_detect(metric, "simpson_") ~ round(value, digits = 1),
    TRUE ~ value
    
  ))

sensitivity.df.subset.long.count<-sensitivity.df.subset.long %>%
  group_by(metric, value) %>% 
  count(value) %>%
  ungroup() %>% 
  mutate(n_samples = 40) %>% 
  mutate(percent_similar = ((n/n_samples)*100)) %>% 
  group_by(metric, percent_similar) %>% 
  filter(!percent_similar<50)
```

```{r SOI}
## Calculate Relative Scope of Impairment. Filter to ref, take metrics that pass 1st screening (barbour >2), combine metric name and predicted response (increase/decrease), take lower 25% for decrease, take top 75% for increase, take IQR
## From Blocksom et al 2001.
## Zach will add this and other screening tools.


reference_sites<-sensitivity.df.subset %>% 
  filter(condition_class =="1") %>% 
  select(site_id)
reference.vec<-c(reference_sites$site_id)

SOI.df<-sensitivity.df.subset.long %>%
  filter(site_id %in% c(reference.vec)) %>% 
  group_by(metric) %>% 
  mutate(Q1 = case_when(
    str_detect(rank, "_decrease") ~ quantile(value, probs = 0.25),
    str_detect(rank, "_increase") ~ quantile(value, probs = 1),
    TRUE ~ value
  )) %>% 
  mutate(Q2 = case_when(
    str_detect(rank, "_decrease") ~ quantile(value, probs = 0),
    str_detect(rank, "_increase") ~ quantile(value, probs = 0.75),
    TRUE ~ value
  )) %>% 
  mutate(IQR = IQR(value)) %>% 
  ungroup() %>% 
  distinct(metric, Q1, Q2, IQR)

SOI.df<-SOI.df %>% 
  mutate(SOI = (IQR/(Q1-Q2)))


```

## Summarize and remove failed metrics
```{r }
# Remove bad metrics
# Replot correlations. 


# Standardizing scores
# Maybe Skip Standardizing scores (old IBI method in place of logistic regr.). Matt checked to see how this performed in comparison.
#       Convert to long DF, determine 5th and 9th percetile for all sites (not just training). If decreases. Block below calculates score for each metric for each site.

metrics.df.standardized.long.percentiles <-metrics.df.standardized.long %>%
  group_by(metric) %>% 
  mutate(Q_5th = quantile(value, probs = 0.05)) %>% 
  mutate(Q_95th =  quantile(value, probs = 0.95)) %>% 
  ungroup() %>% 
  mutate(SCORE = case_when(
    disturbance == "decrease" ~ ((value - Q_5th)/(Q_95th-Q_5th)),
    disturbance == "increase" ~ ((Q_95th - value)/(Q_95th-Q_5th)),
    
  )) %>% 
  mutate(SCORE = SCORE*100) %>% 
  select(uniqueid, metric, SCORE)

# Need to Truncate Scores >100 to 100 and <0 to 0 (is this for traditional method?)


# Remove redundant metrics from corr.
# Sum scores for standardized (is this for traditional method?)



# Look to see how metric and score correlate with abiotic


# DL most recent edits, run through code

# Matt sent- Cross validation (logistic regression?) https://www.youtube.com/watch?v=fSytzGwwBVw 

```


```{r}

```

