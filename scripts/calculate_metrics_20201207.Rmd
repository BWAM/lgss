---
title: "calculate_metrics_20201207"
output: html_document
---

# Data prep 

```{r Load main libs and set directories}
library(tidyverse)
library(mmir)

root.dir <- rprojroot::find_root("lgss.Rproj")
datamod.dir <- file.path("C:/Users/gmlemley/New York State Office of Information Technology Services/SMAS - Streams Data Modernization/Cleaned Files/FINAL_RELOADS_SEPT2020")

```


```{r Load sample taxa and prep}

taxa.df <- read_csv(file.path(root.dir, "data/compile_2015-2019/bugs", "2015-2019_lowgrad_taxa_unique_long_speciesfill_20210111.csv")) %>% 
  # Filter out sites to be omitted (low sample counts or poor sample collected)
  filter(!(site_id %in% c(
    "17-PECN-12.4",
    "13-WALK-35.6",
    "13-IDNK-0.5")))
  
# Create nested dataframe
nest.df <- taxa.df %>%
  group_nest(site_id, .key = "data")

```

```{r Exploring taxa, eval = FALSE}
taxa.df.coleop.fam <- taxa.df %>% 
  filter(order %in% "coleoptera") #%>% 
  # distinct(family)

```


# Calculate metrics

```{r Tolerance Metric (HBI)}

taxa_tol.df <- nest.df %>%
  mutate(
    hbi_taxa_tolerance = taxa_tol_index(.dataframe = .,
                                    .key_col = site_id,
                                    .counts_col = count,
                                    .tol_col = tol_int,
                                    .unnest_col = data)
  ) %>% 
  select(-data)

```

## Richness Metrics

```{r Standard Richness}

rich_std.df <- nest.df %>% 
  mutate(
    # Class level richness
    rich_class = taxa_rich(.dataframe = .,
                           .key_col = site_id,
                           .counts_col = count,
                           .group_col = class,
                           .unnest_col = data),
    # Order level richness
    rich_order = taxa_rich(.dataframe = .,
                           .key_col = site_id,
                           .counts_col = count,
                           .group_col = order,
                           .unnest_col = data),
    # Family level richness
    rich_family = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = family,
                            .unnest_col = data),
    # Genus level richness
    rich_genus = taxa_rich(.dataframe = .,
                           .key_col = site_id,
                           .counts_col = count,
                           .group_col = genus,
                           .unnest_col = data),
    # Target taxon level richness
    rich_ttaxa = taxa_rich(.dataframe = .,
                           .key_col = site_id,
                           .counts_col = count,
                           .group_col = ttaxa,
                           .unnest_col = data),
    # Non-insecta richness
    rich_non_insecta = taxa_rich(.dataframe = .,
                         .key_col = site_id,
                         .counts_col = count,
                         .group_col = ffg,
                         .unnest_col = data,
                         .filter = !(class %in% "insecta")),
    # # Insecta richness
    # rich_insecta = taxa_rich(.dataframe = .,
    #                      .key_col = site_id,
    #                      .counts_col = count,
    #                      .group_col = ffg,
    #                      .unnest_col = data,
    #                      .filter = class %in% "insecta"),
    # Functional Feeding group richness
    rich_ffg = taxa_rich(.dataframe = .,
                         .key_col = site_id,
                         .counts_col = count,
                         .group_col = ffg,
                         .unnest_col = data,
                         .filter = !is.na(ffg))

    # Tolerance classification richness
    # rich_tolerance = taxa_rich(.dataframe = .,
    #                         .key_col = site_id,
    # .counts_col = count,
    #                         .group_col = tol_char,
    #                         .unnest_col = data,
    #                         .filter = !is.na(tol_char))
    # # Tolerance value richness
    # rich_tolerance_num = taxa_rich(.dataframe = .,
    #                         .key_col = site_id,
    # .counts_col = count,
    #                         .group_col = tol_int,
    #                         .unnest_col = data,
    #                         .filter = !is.na(tol_int))
  ) %>% 
  select(-data)

```

```{r Subgroup Richness}

rich_subgr.df <- nest.df %>%
  mutate(
    rich_ttaxa_ep = taxa_rich(.dataframe = .,
                              .key_col = site_id,
                              .counts_col = count,
                              .group_col = ttaxa,
                              .filter = order %in% c("ephemeroptera",
                                                     "plecoptera"),
                              .unnest_col = data),
    rich_ttaxa_et = taxa_rich(.dataframe = .,
                              .key_col = site_id,
                              .counts_col = count,
                              .group_col = ttaxa,
                              .filter = order %in% c("ephemeroptera",
                                                     "trichoptera"),
                              .unnest_col = data),
    rich_ttaxa_pt = taxa_rich(.dataframe = .,
                              .key_col = site_id,
                              .counts_col = count,
                              .group_col = ttaxa,
                              .filter = order %in% c("plecoptera",
                                                     "trichoptera"),
                              .unnest_col = data),
    rich_ttaxa_ept = taxa_rich(.dataframe = .,
                               .key_col = site_id,
                               .counts_col = count,
                               .group_col = ttaxa,
                               .filter = order %in% c("ephemeroptera",
                                                      "plecoptera",
                                                      "trichoptera"),
                               .unnest_col = data),
    rich_ttaxa_pote = taxa_rich(.dataframe = .,
                                 .key_col = site_id,
                                 .counts_col = count,
                                 .group_col = ttaxa,
                                 .filter = order %in% c("plecoptera",
                                                        "odonata",
                                                        "trichoptera",
                                                        "ephemeroptera"),
                                 .unnest_col = data),
    rich_ttaxa_potec = taxa_rich(.dataframe = .,
                                 .key_col = site_id,
                                 .counts_col = count,
                                 .group_col = ttaxa,
                                 .filter = order %in% c("plecoptera",
                                                        "coleoptera",
                                                        "odonata",
                                                        "trichoptera",
                                                        "ephemeroptera"),
                                 .unnest_col = data),
    # Zach said this is usually specific to lakes, but keep it. May be good for LG.
    rich_ttaxa_cote = taxa_rich(.dataframe = .,
                                .key_col = site_id,
                                .counts_col = count,
                                .group_col = ttaxa,
                                .filter = order %in% c("coleoptera",
                                                       "odonata",
                                                       "trichoptera",
                                                       "ephemeroptera"),
                                .unnest_col = data),
    rich_ttaxa_cot = taxa_rich(.dataframe = .,
                               .key_col = site_id,
                               .counts_col = count,
                               .group_col = ttaxa,
                               .filter = order %in% c("coleoptera",
                                                      "odonata",
                                                      "trichoptera"),
                               .unnest_col = data),
    rich_ttaxa_coe = taxa_rich(.dataframe = .,
                               .key_col = site_id,
                               .counts_col = count,
                               .group_col = ttaxa,
                               .filter = order %in% c("coleoptera",
                                                      "odonata",
                                                      "ephemeroptera"),
                               .unnest_col = data),
    rich_ttaxa_cte = taxa_rich(.dataframe = .,
                               .key_col = site_id,
                               .counts_col = count,
                               .group_col = ttaxa,
                               .filter = order %in% c("coleoptera",
                                                      "trichoptera",
                                                      "ephemeroptera"),
                               .unnest_col = data),
    # Below Metrics were in old LG metrics script
    rich_ttaxa_toe = taxa_rich(.dataframe = .,
                               .key_col = site_id,
                               .counts_col = count,
                               .group_col = ttaxa,
                               .filter = order %in% c("trichoptera",
                                                      "odonata",
                                                      "ephemeroptera"),
                               .unnest_col = data),
    rich_ttaxa_mol = taxa_rich(.dataframe = .,
                               .key_col = site_id,
                               .counts_col = count,
                               .group_col = ttaxa,
                               .filter = phylum %in% "mollusca",
                               .unnest_col = data),
    # Already done in taxa_seq() chunk, but used to calculate subgr
    rich_ttaxa_amphi = taxa_rich(.dataframe = .,
                                 .key_col = site_id,
                                 .counts_col = count,
                                 .group_col = ttaxa,
                                 .filter = order %in% "amphipoda",
                                 .unnest_col = data),
    rich_ttaxa_mol_amph = rich_ttaxa_mol + rich_ttaxa_amphi,
    rich_ttaxa_crust = taxa_rich(.dataframe = .,
                                 .key_col = site_id,
                                 .counts_col = count,
                                 .group_col = ttaxa,
                                 .filter = subphylum %in% "crustacea",
                                 .unnest_col = data),
    rich_ttaxa_mol_crust = rich_ttaxa_crust + rich_ttaxa_mol,
    rich_ttaxa_chironominae = taxa_rich(.dataframe = .,
                                        .key_col = site_id,
                                        .counts_col = count,
                                        .group_col = ttaxa,
                                        .filter = subfamily %in% "chironominae",
                                        .unnest_col = data),
    rich_ttaxa_non_insecta = taxa_rich(.dataframe = .,
                                        .key_col = site_id,
                                        .counts_col = count,
                                        .group_col = ttaxa,
                                        .filter = !(class %in% "insecta"),
                                        .unnest_col = data),
    # Richness of intolerant and facultative Taxa 
    rich_ttaxa_tol_0to7 = taxa_rich(.dataframe = .,
                                    .key_col = site_id,
                                    .counts_col = count,
                                    .group_col = ttaxa,
                                    .filter = tol_int <= 7,
                                    .unnest_col = data)
  ) %>% 
  select(-data)

# rich_subgr.df %>%
#   mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()
```


```{r Percent Richness}

rich_pct.df <- nest.df %>% 
  mutate(
    pct_rich_ttaxa_ep = taxa_pct_rich(.dataframe = .,
                                      .key_col = site_id,
                                      .counts_col = count,
                                      .group_col = ttaxa,
                                      .filter = order %in% c("ephemeroptera", 
                                                             "plecoptera"),
                                      .unnest_col = data),
    pct_rich_ttaxa_et = taxa_pct_rich(.dataframe = .,
                                      .key_col = site_id,
                                      .counts_col = count,
                                      .group_col = ttaxa,
                                      .filter = order %in% c("trichoptera",
                                                             "ephemeroptera"),
                                      .unnest_col = data), 
    pct_rich_ttaxa_pt = taxa_pct_rich(.dataframe = .,
                                      .key_col = site_id,
                                      .counts_col = count,
                                      .group_col = ttaxa,
                                      .filter = order %in% c("trichoptera",
                                                             "plecoptera"),
                                      .unnest_col = data), 
    pct_rich_ttaxa_ept = taxa_pct_rich(.dataframe = .,
                                       .key_col = site_id,
                                       .counts_col = count,
                                       .group_col = ttaxa,
                                       .filter = order %in% c("plecoptera",
                                                              "trichoptera",
                                                              "ephemeroptera"),
                                       .unnest_col = data), 
    pct_rich_ttaxa_pote = taxa_pct_rich(.dataframe = .,
                                         .key_col = site_id,
                                         .counts_col = count,
                                         .group_col = ttaxa,
                                         .filter = order %in% c("plecoptera",
                                                                "odonata",
                                                                "trichoptera",
                                                                "ephemeroptera"),
                                         .unnest_col = data), 
    pct_rich_ttaxa_potec = taxa_pct_rich(.dataframe = .,
                                         .key_col = site_id,
                                         .counts_col = count,
                                         .group_col = ttaxa,
                                         .filter = order %in% c("plecoptera",
                                                                "coleoptera",
                                                                "odonata",
                                                                "trichoptera",
                                                                "ephemeroptera"),
                                         .unnest_col = data), 
    pct_rich_ttaxa_cote = taxa_pct_rich(.dataframe = .,
                                        .key_col = site_id,
                                        .counts_col = count,
                                        .group_col = ttaxa,
                                        .filter = order %in% c("coleoptera",
                                                               "odonata",
                                                               "trichoptera",
                                                               "ephemeroptera"),
                                        .unnest_col = data),
    pct_rich_ttaxa_cot = taxa_pct_rich(.dataframe = .,
                                       .key_col = site_id,
                                       .counts_col = count,
                                       .group_col = ttaxa,
                                       .filter = order %in% c("coleoptera",
                                                              "odonata",
                                                              "trichoptera"),
                                       .unnest_col = data),
    pct_rich_ttaxa_toe = taxa_pct_rich(.dataframe = .,
                                       .key_col = site_id,
                                       .counts_col = count,
                                       .group_col = ttaxa,
                                       .filter = order %in% c("odonata",
                                                              "trichoptera",
                                                              "ephemeroptera"),
                                       .unnest_col = data),
    pct_rich_ttaxa_cte = taxa_pct_rich(.dataframe = .,
                                       .key_col = site_id,
                                       .counts_col = count,
                                       .group_col = ttaxa,
                                       .filter = order %in% c("coleoptera",
                                                              "trichoptera",
                                                              "ephemeroptera"),
                                       .unnest_col = data),
    pct_rich_ttaxa_coe = taxa_pct_rich(.dataframe = .,
                                       .key_col = site_id,
                                       .counts_col = count,
                                       .group_col = ttaxa,
                                       .filter = order %in% c("coleoptera",
                                                              "odonata",
                                                              "ephemeroptera"),
                                       .unnest_col = data),
    pct_rich_ttaxa_mol = taxa_pct_rich(.dataframe = .,
                                       .key_col = site_id,
                                       .counts_col = count,
                                       .group_col = ttaxa,
                                       .filter = phylum %in% "mollusca",
                                       .unnest_col = data), 
    pct_rich_ttaxa_crust = taxa_pct_rich(.dataframe = .,
                                         .key_col = site_id,
                                         .counts_col = count,
                                         .group_col = ttaxa,
                                         .filter = subphylum %in% "crustacea",
                                         .unnest_col = data), 
    pct_rich_ttaxa_chironominae = taxa_pct_rich(.dataframe = .,
                                                .key_col = site_id,
                                                .counts_col = count,
                                                .group_col = ttaxa,
                                                .filter = subfamily %in% "chironominae",
                                                .unnest_col = data),
    pct_rich_ttaxa_non_insecta = taxa_pct_rich(.dataframe = .,
                                                .key_col = site_id,
                                                .counts_col = count,
                                                .group_col = ttaxa,
                                                .filter = !(class %in% "insecta"),
                                                .unnest_col = data),
     # pct_rich_ttaxa_insecta = taxa_pct_rich(.dataframe = .,
     #                                            .key_col = site_id,
     #                                            .counts_col = count,
     #                                            .group_col = ttaxa,
     #                                            .filter = class %in% "insecta",
     #                                            .unnest_col = data),
   # Percent Richness of Intolerant and Facultative Taxa
    pct_rich_ttaxa_tol_0to7 = taxa_pct_rich(.dataframe = .,
                                            .key_col = site_id,
                                            .counts_col = count,
                                            .group_col = ttaxa,
                                            .filter = tol_int <= 6,
                                            .unnest_col = data)
  ) %>% 
  select(-data)

```


## Diversity Metrics

```{r Diversity}

div.df <- nest.df %>%
  mutate(
    shannon_ttaxa = taxa_div(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .group_col = ttaxa,
                             .job = "shannon",
                             .base_log = 2,
                             .q = NA,
                             .unnest_col = data),
    simpson_ttaxa = taxa_div(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .group_col = ttaxa,
                             .job = "simpson",
                             .q = NA,
                             .unnest_col = data),
    margalef_ttaxa = taxa_div(.dataframe = .,
                              .key_col = site_id,
                              .counts_col = count,
                              .group_col = ttaxa,
                              .job = "margalef",
                              .q = NA,
                              .unnest_col = data),
    menhinick_ttaxa = taxa_div(.dataframe = .,
                               .key_col = site_id,
                               .counts_col = count,
                               .group_col = ttaxa,
                               .job = "menhinick",
                               .q = NA,
                               .unnest_col = data),
    pielou_ttaxa = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .job = "pielou",
                            .q = NA,
                            .unnest_col = data)
  ) %>% 
  select(-data)

# div.df %>%
#   mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()
```

```{r Subgroup Diversity}

div_subgr.df <- nest.df %>%
  mutate(
    gini_simpson_ttaxa_ept = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                   "plecoptera",
                                                   "trichoptera"),
                            .job = "gini_simpson",
                            .q = NA,
                            .unnest_col = data),
    gini_simpson_ttaxa_toe = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                   "odonata",
                                                   "trichoptera"),
                            .job = "gini_simpson",
                            .q = NA,
                            .unnest_col = data),
    gini_simpson_ttaxa_et = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                   "trichoptera"),
                            .job = "gini_simpson",
                            .q = NA,
                            .unnest_col = data),
    simpson_ttaxa_ept = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                   "plecoptera",
                                                   "trichoptera"),
                            .job = "simpson",
                            .q = NA,
                            .unnest_col = data),
    simpson_ttaxa_et = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                   "trichoptera"),
                            .job = "simpson",
                            .q = NA,
                            .unnest_col = data),
    simpson_ttaxa_pote = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("plecoptera",
                                                   "odonata",
                                                   "trichoptera",
                                                   "ephemeroptera"), 
                            .job = "simpson",
                            .q = NA,
                            .unnest_col = data),
    simpson_ttaxa_potec = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "plecoptera",
                                                   "odonata",
                                                   "trichoptera",
                                                   "ephemeroptera"), 
                            .job = "simpson",
                            .q = NA,
                            .unnest_col = data),
    simpson_ttaxa_cote = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "odonata",
                                                   "trichoptera",
                                                   "ephemeroptera"), 
                            .job = "simpson",
                            .q = NA,
                            .unnest_col = data),
    simpson_ttaxa_cot = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "odonata",
                                                   "trichoptera"), 
                            .job = "simpson",
                            .q = NA,
                            .unnest_col = data),
    simpson_ttaxa_toe = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("odonata",
                                                   "trichoptera",
                                                   "ephemeroptera"), 
                            .job = "simpson",
                            .q = NA,
                            .unnest_col = data),
    simpson_ttaxa_coe = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "odonata",
                                                   "ephemeroptera"), 
                            .job = "simpson",
                            .q = NA,
                            .unnest_col = data),
    simpson_ttaxa_cte = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "trichoptera",
                                                   "ephemeroptera"), 
                            .job = "simpson",
                            .q = NA,
                            .unnest_col = data),
    simpson_ttaxa_non_insecta = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = !(class %in% "insecta"), 
                            .job = "simpson",
                            .q = NA,
                            .unnest_col = data),
    shannon_ttaxa_ept = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                   "plecoptera",
                                                   "trichoptera"),
                            .job = "shannon",
                            .base_log = 2,
                            .q = NA,
                            .unnest_col = data),
    shannon_ttaxa_et = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .filter = order %in% c("ephemeroptera",
                                                   "trichoptera"),
                            .job = "shannon",
                            .base_log = 2,
                            .q = NA,
                            .unnest_col = data),
    shannon_ttaxa_pote = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("plecoptera",
                                                   "odonata",
                                                   "trichoptera",
                                                   "ephemeroptera"), 
                            .job = "shannon",
                            .base_log = 2,
                            .q = NA,
                            .unnest_col = data),  
    shannon_ttaxa_potec = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "plecoptera",
                                                   "odonata",
                                                   "trichoptera",
                                                   "ephemeroptera"), 
                            .job = "shannon",
                            .base_log = 2,
                            .q = NA,
                            .unnest_col = data),  
    shannon_ttaxa_cote = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "odonata",
                                                   "trichoptera",
                                                   "ephemeroptera"), 
                            .job = "shannon",
                            .base_log = 2,
                            .q = NA,
                            .unnest_col = data),  
    shannon_ttaxa_cot = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "odonata",
                                                   "trichoptera"), 
                            .job = "shannon",
                            .base_log = 2,
                            .q = NA,
                            .unnest_col = data),    
    shannon_ttaxa_toe = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("odonata",
                                                   "trichoptera",
                                                   "ephemeroptera"), 
                            .job = "shannon",
                            .base_log = 2,
                            .q = NA,
                            .unnest_col = data),  
    shannon_ttaxa_cte = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "trichoptera",
                                                   "ephemeroptera"), 
                            .job = "shannon",
                            .base_log = 2,
                            .q = NA,
                            .unnest_col = data),  
    shannon_ttaxa_coe = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = order %in% c("coleoptera",
                                                   "odonata",
                                                   "ephemeroptera"), 
                            .job = "shannon",
                            .base_log = 2,
                            .q = NA,
                            .unnest_col = data),
    shannon_ttaxa_non_insecta = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .group_col = ttaxa,
                            .counts_col = count,
                            .filter = !(class %in% "insecta"), 
                            .job = "shannon",
                            .base_log = 2,
                            .q = NA,
                            .unnest_col = data),
    # margalef_ttaxa_toe = taxa_div(.dataframe = .,
    #                         .key_col = site_id,
    #                         .counts_col = count,
    #                         .group_col = ttaxa,
    #                         .job = "margalef",
    #                         .filter = order %in% c("odonata",
    #                                                "trichoptera",
    #                                                "ephemeroptera"), 
    #                         .unnest_col = data),
    # menhinick_ttaxa_toe = taxa_div(.dataframe = .,
    #                         .key_col = site_id,
    #                         .counts_col = count,
    #                         .group_col = ttaxa,
    #                         .job = "menhinick",
    #                         .filter = order %in% c("odonata",
    #                                                "trichoptera",
    #                                                "ephemeroptera"), 
    #                         .unnest_col = data),
    # pielou_ttaxa_toe = taxa_div(.dataframe = .,
    #                         .key_col = site_id,
    #                         .counts_col = count,
    #                         .group_col = ttaxa,
    #                         .job = "pielou",
    #                         .filter = order %in% c("odonata",
    #                                                "trichoptera",
    #                                                "ephemeroptera"), 
    #                         .unnest_col = data),
    # margalef_ttaxa_et = taxa_div(.dataframe = .,
    #                         .key_col = site_id,
    #                         .counts_col = count,
    #                         .group_col = ttaxa,
    #                         .job = "margalef",
    #                         .filter = order %in% c("trichoptera",
    #                                                "ephemeroptera"), 
    #                         .unnest_col = data),
    # menhinick_ttaxa_et = taxa_div(.dataframe = .,
    #                         .key_col = site_id,
    #                         .counts_col = count,
    #                         .group_col = ttaxa,
    #                         .job = "menhinick",
    #                         .filter = order %in% c("trichoptera",
    #                                                "ephemeroptera"), 
    #                         .unnest_col = data),
    # pielou_ttaxa_et = taxa_div(.dataframe = .,
    #                         .key_col = site_id,
    #                         .counts_col = count,
    #                         .group_col = ttaxa,
    #                         .job = "pielou",
    #                         .filter = order %in% c("trichoptera",
    #                                                "ephemeroptera"), 
    #                         .unnest_col = data),
    # Diversity of Intolerant and Facultative Taxa
    # shannon_ttaxa_tol_0to7 = taxa_div(.dataframe = .,
    #                         .key_col = site_id,
    #                         .group_col = ttaxa,
    #                         .counts_col = count,
    #                         .filter = tol_int <=7,
    #                         .job = "shannon",
    #                         .base_log = 2,
    #                         .unnest_col = data),
    # simpson_ttaxa_tol_0to7 = taxa_div(.data = .,
    #                         .key_col = site_id,
    #                         .group_col = ttaxa,
    #                         .counts_col = count,
    #                         .filter = tol_int <=7,
    #                         .job = "simpson",
    #                         .unnest_col = data)
    # margalef_ttaxa_tol_0to7 = taxa_div(.dataframe = .,
    #                         .key_col = site_id,
    #                         .counts_col = count,
    #                         .group_col = ttaxa,
    #                         .job = "margalef",
    #                         .filter = tol_int <=7,
    #                         .unnest_col = data),
    # menhinick_ttaxa_tol_0to7 = taxa_div(.dataframe = .,
    #                         .key_col = site_id,
    #                         .counts_col = count,
    #                         .group_col = ttaxa,
    #                         .job = "menhinick",
    #                         .filter = tol_int <=7,
    #                         .unnest_col = data),
    # pielou_ttaxa_tol_0to7 = taxa_div(.dataframe = .,
    #                         .key_col = site_id,
    #                         .counts_col = count,
    #                         .group_col = ttaxa,
    #                         .job = "pielou",
    #                         .filter = tol_int <=7,
    #                         .unnest_col = data)
  ) %>% 
  select(-data)

# div_subgr.df %>%
#   mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()
```

## Dominance Metrics

```{r Dominance}

dom.df <- nest.df %>%
  mutate(
    dom_1_ttaxa = taxa_dom(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .dom_level = 1,
                            .unnest_col = data),
    dom_2_ttaxa = taxa_dom(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .dom_level = 2,
                            .unnest_col = data),
    dom_3_ttaxa = taxa_dom(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .dom_level = 3,
                            .unnest_col = data),
    dom_4_ttaxa = taxa_dom(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .dom_level = 4,
                            .unnest_col = data),
    dom_5_ttaxa = taxa_dom(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = ttaxa,
                            .dom_level = 5,
                            .unnest_col = data)
  ) %>% 
  select(-data)

# dom.df %>%
#   mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()
```


## Community Metrics

```{r Percentages}

pct.df <- nest.df %>% 
  mutate(
     pct_ep = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("ephemeroptera", 
                                                    "plecoptera"),
                             .unnest_col = data),
     pct_et = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_pt = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("trichoptera",
                                                    "plecoptera"),
                             .unnest_col = data), 
     pct_ept = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("plecoptera",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_pote = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("plecoptera",
                                                    "odonata",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_potec = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("plecoptera",
                                                    "coleoptera",
                                                    "odonata",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_cote = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("coleoptera",
                                                    "odonata",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data),
     pct_toe = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("odonata",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data), 
     pct_cot = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("coleoptera",
                                                    "odonata",
                                                    "trichoptera"),
                             .unnest_col = data),
     pct_cte = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("coleoptera",
                                                    "trichoptera",
                                                    "ephemeroptera"),
                             .unnest_col = data),
     pct_coe = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = order %in% c("coleoptera",
                                                    "odonata",
                                                    "ephemeroptera"),
                             .unnest_col = data),
     pct_mol = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = phylum %in% "mollusca",
                             .unnest_col = data), 
     pct_crust = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = subphylum %in% "crustacea",
                             .unnest_col = data), 
     pct_chironominae = taxa_pct(.dataframe = .,
                             .key_col = site_id,
                             .counts_col = count,
                             .filter = subfamily %in% "chironominae",
                             .unnest_col = data),
     pct_non_insecta = taxa_pct(.dataframe = .,
                                .key_col = site_id,
                                .counts_col = count,
                                .filter = !(class %in% "insecta"),
                                .unnest_col = data)
) %>% 
  select(-data)
# pct.df %>%
#   mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()

```


## Sequence Metrics

```{r}

seq.df <- nest.df %>%
  # Append all of the results as columns to a single DF.
  bind_cols(
    # Sequence through ttaxa for each unique column specified in the .filter_cols_vec.
    taxa_seq(.dataframe = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class",
                                  "order",
                                  "family",
                                  "tol_char",
                                  "ffg"),
             .group_col = ttaxa,
             .job = "rich",
             .exclude_pattern = "undetermined",
             .unnest_col = data),
    # Sequence through each unique column specified in the .filter_cols_vec 
    # to calculate ttaxa percent richness.
    taxa_seq(.dataframe = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class",
                                  "order",
                                  "family",
                                  "tol_char",
                                  "ffg"),
             .group_col = ttaxa,
             .job = "pct_rich",
             .exclude_pattern = "undetermined",
             .unnest_col = data),
    taxa_seq(.dataframe = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class",
                                  "order",
                                  "suborder",
                                  "family",
                                  "genus",
                                  "tol_char",
                                  "ffg"),
             .job = "pct",
             .exclude_pattern = "undetermined",
             .unnest_col = data),
    # Spot-checked that manual pct_amphi came out the same as pct_NULL_amphipoda (produced by below)
    taxa_seq(.dataframe = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class",
                                  "order", 
                                  "family",
                                  "tol_char",
                                  "ffg"),
             .group_col = ttaxa,
             .base_log = 2,
             .job = "shannon",
             .exclude_pattern = "undetermined",
             .unnest_col = data),
    taxa_seq(.dataframe = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class",
                                  "order", 
                                  "family",
                                  "tol_char",
                                  "ffg"),
             .group_col = ttaxa,
             .job = "simpson",
             .exclude_pattern = "undetermined",
             .unnest_col = data)
  ) %>% 
  select(-data)

seq.names <- as.data.frame(names(seq.df))

```



## Combine metrics dataframes

```{r}
# metrics.all <- div_subgr.df %>%
#   left_join(div.df) %>% 
#   left_join(dom.df) %>% 
#   left_join(rich_std.df) %>% 
#   left_join(rich_pct.df) %>% 
#   left_join(pct.df) %>% 
#   left_join(rich_subgr.df) %>% 
#   left_join(taxa_tol.df) %>% 
#   left_join(seq.df)

# Cleaner way to join
metrics.df <- list(  div_subgr.df,
                     div.df,
                     dom.df,
                     rich_std.df,
                     rich_pct.df,
                     pct.df,
                     rich_subgr.df,
                     taxa_tol.df,
                     seq.df
                   ) %>% 
  plyr::join_all(., by = c("site_id"))

metrics.names <- names(metrics.df)
metrics.names.df <- as.data.frame(metrics.names, col.names = c("metrics", "x")) %>% 
  filter(!(metrics.names %in% "site_id"))

# Invesitage rich_ffg issues
# metrics.df.rich_ffg <- metrics.df %>% 
#   select(site_id, condition_class, rich_ffg)
# Checks out OK


# Look for dups
# metrics.dups <- metrics.names.df %>%
#   mutate(n = n()) %>%
#   group_by(metrics.names) %>%
#   filter(n>1)
# 
#   group_by(accession) %>%
#   mutate(n = n()) %>%
#   filter(n > 1)
# 
# metrics.dups %>% janitor::get_dupes(metrics.all)
# 
# # library(digest)
# test <- metrics.all[!duplicated(lapply(metrics.all, digest::digest))]


# Attach disturbance categories
# condition <- read.csv(file.path("C:/Data/LGSS_scripting/lgss/data/compile_2015-2019/condition_classes", "2015-2019_LG_condclasses_20201216.csv")) %>%   select(-PC1)

# 5/26/21 - New condition classes created due to erroneous pH value found. Had to regenerate PCA (11 sites changed classes)
# condition <- read.csv(file.path("C:/Data/LGSS_scripting/lgss/data/compile_2015-2019/condition_classes", "2015-2019_LG_condclasses_20210526_CARL-pHfixed.csv")) %>%   select(-PC1)

# 6/8/21 - New condition classes after omitting and reclassifying sites (see PCA script)
condition <- read.csv(file.path("C:/Data/LGSS_scripting/lgss/data/compile_2015-2019/condition_classes", "2015-2019_LG_condclasses_20210611-reclass.csv")) %>%   
  select(-PC1)

metrics.df <- metrics.df %>%
  left_join(., condition) %>% 
  select(site_id, condition_class, everything()) #%>% 
  # filter(!is.na(condition_class))

# Investigate certain metrics and bugs
# metrics.sub <- metrics.all %>% 
#   select(site_id, pct_amphi, pct_NULL_amphipoda)

# Join site class to taxa
taxa.df.class <- taxa.df %>% left_join(condition, by = "site_id")

# Look at plecop only
taxa.df.class.plecop <- taxa.df.class %>% filter(order %in% "plecoptera")

```

```{r Clean up workspace, eval=FALSE}
rm(master.taxa.fill,
   taxa.df,
   nest.df,
   div_subgr.df,
   div.df,
   dom.df,
   rich_std.df,
   rich_pct.df,
   pct.df,
   rich_subgr.df,
   taxa_tol.df,
   seq.df,
   seq.names,
   condition)
```


## PMA calculation

Percent Model Affinity of Orders - (PMA-O) Is a measure of order level similarity to a model based
on the reference streams Novak and Bode (1992).
```{r, eval = FALSE}

#### SKIP THIS CHUNK AND RUN TO PMA CALCULATION CHUNK THEN COME BACK TO THIS CHUNK AND RERUN FROM HERE DOWN ###

######
## WARNING: The constants below are from the training set produced used set.seed(80) prior to the Rstudio update that changed the outcome. They were changed before I realized that this issue had occurred. If rerunning using this original training set, use those constants entered in the Rmd prior to 1/5/21 (access previous github commit).
######
metrics.df <- metrics.df %>% 
    mutate(PMA_clitellata = train.df.PMA$pct_clitellata,
           PMA_ephemeroptera = train.df.PMA$pct_ephemeroptera,
           PMA_plecoptera = train.df.PMA$pct_plecoptera,
           PMA_coleoptera = train.df.PMA$pct_coleoptera,
           PMA_trichoptera = train.df.PMA$pct_trichoptera,
           PMA_chironomidae = train.df.PMA$pct_chironomidae,
           PMA_other = train.df.PMA$other
    ) %>%
  group_by(site_id) %>% 
  mutate(pct_other = sum(pct_clitellata, pct_ephemeroptera, pct_plecoptera, pct_coleoptera, pct_trichoptera, pct_chironomidae)) %>% 
  mutate(pct_other = 100 - pct_other) %>% 
  ungroup() %>% 
  mutate(PMA_value_clitellata = case_when(
    PMA_clitellata < pct_clitellata ~ PMA_clitellata,
    PMA_clitellata > pct_clitellata ~ pct_clitellata,
  )) %>% 
  mutate(PMA_value_ephemeroptera = case_when(
    PMA_ephemeroptera < pct_ephemeroptera ~ PMA_ephemeroptera,
    PMA_ephemeroptera > pct_ephemeroptera ~ pct_ephemeroptera,
  )) %>% 
  mutate(PMA_value_plecoptera = case_when(
    PMA_plecoptera < pct_plecoptera ~ PMA_plecoptera,
    PMA_plecoptera > pct_plecoptera ~ pct_plecoptera,
  )) %>% 
  mutate(PMA_value_coleoptera = case_when(
    PMA_coleoptera < pct_coleoptera ~ PMA_coleoptera,
    PMA_coleoptera > pct_coleoptera ~ pct_coleoptera,
  )) %>%   
  mutate(PMA_value_trichoptera = case_when(
    PMA_trichoptera < pct_trichoptera ~ PMA_trichoptera,
    PMA_trichoptera > pct_trichoptera ~ pct_trichoptera,
  )) %>% 
  mutate(PMA_value_chironomidae = case_when(
    PMA_chironomidae < pct_chironomidae ~ PMA_chironomidae,
    PMA_chironomidae > pct_chironomidae ~ pct_chironomidae,
  )) %>% 
  mutate(PMA_value_other = case_when(
    PMA_other < pct_other ~ PMA_other,
    PMA_other > pct_other ~ pct_other,
  )) %>% 
  group_by(site_id) %>% 
  mutate(PMA = sum(PMA_value_clitellata, PMA_value_ephemeroptera, PMA_value_plecoptera, PMA_value_coleoptera, PMA_value_trichoptera, PMA_value_chironomidae, PMA_value_other)) %>% 
  ungroup() %>% 
  select(-c(PMA_value_clitellata, PMA_value_ephemeroptera, PMA_value_plecoptera, PMA_value_coleoptera, PMA_value_trichoptera, PMA_value_chironomidae, PMA_value_other))

```



# Subsampling


```{r Split into training and test (validation) datasets}

library(tidymodels)

# Keep the set.seed number the same to get the same subsampled traning dataset for each run. (Change this to create a new training dataset. Original is 80)

### RUN FURTHER SUBSAMPLES TO SEE WHICH METRICS COME OUT through filter. Then set final seed for training.
set.seed(60)
# set.seed(70)
# set.seed(80)
# set.seed(90)
# set.seed(5122)

train_test_split <- metrics.df %>% 
  # mutate(condition_class = factor(condition_class, levels = c("1","3","4","2"))) %>% 
  # filter(condition_class %in% c("1", "3")) %>%
  rsample::initial_split(prop = 2/3, strata = condition_class)

# Create training dataset
train.df <- training(train_test_split) %>% 
  filter(condition_class %in% c("1", "3")) 

# Create testing dataset
test.df <- testing(train_test_split) %>% 
  filter(condition_class %in% c("1", "3"))

# List sites for each
test.df.vec <- c(test.df$site_id)
train.df.vec <- c(train.df$site_id)

# Create dataset with class 2 (set aside to help validate later)
# test.class2.df <- metrics.df %>% 
#   filter(condition_class %in% "2") 



###################
###################

### Confirm set.seed(80) reproducibility when running this code. PMA metrics produced in the code chunk below (DF train.df.PMA) should match those entered in chunk above. 
### In case set.seed(80) is no longer reproducible, the following test and training sites were randomly selected using set.seed(80) and used during development of this IBI:

# > test.df.vec
#  [1] "01-GILL-0.3"      "02-CASS-25.6"     "03-JEDO_T3-0.4"  
#  [4] "04-BLAK_T7-3.0"   "04-BLCE-5.2"      "04-WDIT-0.1"     
#  [7] "07-BLDY-0.1"      "07-LITR-0.2"      "07-ONON_W_T7-1.5"
# [10] "07-POBK_T4-1.5"   "08-BLAC-2.5"      "09-CEDL-0.1"     
# [13] "09-LSAL_T1-1.0"   "13-BASC_T17-2.4"  "14-HURL-2.8"     
# [16] "14-TENR-3.7"      "14-WLAK-5.8"      "15-MAWA-3.7"     
# [19] "17-OROW-0.6"      "17-SAMP-2.1"     
# 
# > train.df.vec
#  [1] "01-FISN-2.4"      "01-GOTC-0.2"      "02-RAWS-0.8"     
#  [4] "03-BEAG-1.8"      "03-EMIL_E_T6-0.4" "03-FOMI-5.5"     
#  [7] "03-HRTB-2.2"      "03-JOHN-13.7"     "03-MIDL-2.4"     
# [10] "03-SAND_T21-4.0"  "03-YANT_T1c-0.2"  "04-BLAK_T16-0.8" 
# [13] "04-JCOX-4.6"      "04-JCOX_S-3.7"    "04-SPRG-10.1"    
# [16] "04-WMRSG-0.2"     "05-CAMB-11.2"     "05-CBRO-1.8"     
# [19] "06-NING-7.7"      "07-GEDD-1.4"      "07-HARB-0.5"     
# [22] "07-HENC_T4-1.2"   "07-JACB-1.9"      "07-NINE-0.7"     
# [25] "07-SNDR-1.5"      "07-WBOT-0.3"      "08-BARE_T5-0.5"  
# [28] "08-BENE-0.2"      "08-MURM-3.4"      "09-BIBK-5.4"     
# [31] "09-BLCH-0.2"      "09-ENGL-17.6"     "09-LSUK-11.3"    
# [34] "09-MARA-4.5"      "09-PLMB-12.4"     "09-WSCK-3.4"     
# [37] "10-BISH-0.6"      "10-COLW-0.7"      "10-LSAR_T10-0.3" 
# [40] "10-MILC-6.3"      "10-NSAR_T7-0.8"   "10-PUTM_T5-0.3"  
# [43] "10-TRAE-4.5"      "10-TWOB-3.6"      "11-GORN-6.0"     
# [46] "11-SRUN-3.8"      "11-TEET-0.8"      "11-TOMH-12.2"    
# [49] "13-EBCR-16.3"     "13-IDNK-0.5"      "13-WBLKK-8.9"    
# [52] "16-BOGH-0.3"      "16-WEBA-23.3"     "17-EMED-0.4"     
# [55] "17-GREN-0.8"      "17-MBUR-2.1"      "17-NISS_E-2.6"   
# [58] "17-PECN-8.9"      "17-PENA-1.4"      "17-SANT-1.7"     
# [61] "17-SWML-1.4"    

# PMA values:
#    PMA_clitellata = 4.59,
#    PMA_ephemeroptera = 9.11,
#    PMA_plecoptera = 0.28,
#    PMA_coleoptera = 5.37,
#    PMA_trichoptera = 4.45,
#    PMA_chironomidae = 43.5,
#    PMA_other = 32.7


#########################################################################################################
#########################################################################################################
###### SUBSAMPLE GROUPS ABOVE ARE NO LONGER VALID AFTER RECLASSIFICATION WITH CORRECTED PCA, 5/26/21 ####
#########################################################################################################
#########################################################################################################


# 1st rerun with corrected PCA, 5/26/21
# > test.df.vec
#  [1] "01-GILL-0.3"      "02-CASS-25.6"     "04-JCOX-4.6"      "04-WDIT-0.1"      "04-WMRSG-0.2"     "07-BLDY-0.1"      "07-ONON_W_T7-1.5"
#  [8] "07-POBK_T4-1.5"   "08-BARE_T5-0.5"   "08-MURM-3.4"      "09-ENGL-17.6"     "09-LSAL_T1-1.0"   "13-EBCR-16.3"     "14-TENR-3.7"     
# [15] "14-WLAK-5.8"      "15-MAWA-3.7"      "16-BOGH-0.3"      "17-EMED-0.4"      "17-OROW-0.6"      "17-SWML-1.4" 
# > train.df.PMA
# # A tibble: 1 x 8
#   site_id pct_clitellata pct_ephemeroptera pct_plecoptera pct_coleoptera pct_trichoptera pct_chironomidae other
#     <dbl>          <dbl>             <dbl>          <dbl>          <dbl>           <dbl>            <dbl> <dbl>
# 1      NA           5.02              9.65          0.235           4.53            3.95             41.7  34.9



# 2nd rerun, same input data and seed (set.seed(80)) after R package updates...

# > test.df.vec
#  [1] "01-FISN-2.4"      "03-EMIL_E_T6-0.4" "03-JOHN-13.7"     "03-YANT_T1c-0.2"  "04-JCOX-4.6"      "05-CAMB-11.2"     "07-GEDD-1.4"     
#  [8] "07-ONON_W_T7-1.5" "07-SNDR-1.5"      "08-BLAC-2.5"      "09-CEDL-0.1"      "09-WSCK-3.4"      "10-BISH-0.6"      "10-COLW-0.7"     
# [15] "10-LSAR_T10-0.3"  "10-PUTM_T5-0.3"   "10-TRAE-4.5"      "10-TWOB-3.6"      "11-TOMH-12.2"     "12-BARK-0.6"      "13-BASC_T17-2.4" 
# [22] "17-SANT-1.7"     
# > train.df.PMA
# # A tibble: 1 x 8
#   site_id pct_clitellata pct_ephemeroptera pct_plecoptera pct_coleoptera pct_trichoptera pct_chironomidae other
#     <dbl>          <dbl>             <dbl>          <dbl>          <dbl>           <dbl>            <dbl> <dbl>
# 1      NA           4.50              10.4          0.289           5.11            4.91             37.8  37.0
  
  
#######################
#######################

### Export final training/test site lists for import later on if not reproducible with set.seed().

# write.csv(test.df.vec, file.path(root.dir, "data/metrics/june2021_rerun/test_subsample_setseed90_2021-06-01.csv"), row.names = F)
# write.csv(train.df.vec, file.path(root.dir, "data/metrics/june2021_rerun/train_subsample_setseed90_2021-06-01.csv"), row.names = F)
# 
write.csv(test.df, file.path(root.dir, "data/metrics/june2021_rerun/test_subsample_setseed60_allmetrics_2021-06-14.csv"), row.names = F)
write.csv(train.df, file.path(root.dir, "data/metrics/june2021_rerun/train_subsample_setseed60_allmetrics_2021-06-14.csv"), row.names = F)

##################


```

# Calculating pct comp for PMA metric above
```{r, eval=FALSE}

### Determining percent composition of each major group for PMA calculation above

train.df.PMA <- train.df %>% 
  filter(condition_class == "1") %>% 
  group_by(site_id) %>% 
  select(site_id, 
         pct_clitellata,   #Represents Oligochaeta
         pct_ephemeroptera, 
         pct_plecoptera, 
         pct_coleoptera, 
         pct_trichoptera,
         pct_chironomidae)  %>% 
  mutate(other = sum(pct_clitellata, pct_ephemeroptera, pct_plecoptera, pct_coleoptera, pct_trichoptera, pct_chironomidae)) %>% 
  mutate(other= 100-other) %>% 
  ungroup() %>% 
  summarise_all(list(mean))


### Could also calculate PMA for FFG Composition (PMA-FFG)

```
# Calculating sensitivies and initial filtering 

```{r Calculate Sensitivity and filter}

# For full dataset
# long.all.df <- metrics.df %>% 
#   pivot_longer(cols = c(-condition_class, -site_id),
#                names_to = "metric",
#                values_to = "value")
# 
# sens.all.df <- mmir::sensitivity(.dataframe = long.all.df,
#                               .metric_col = metric,
#                               .value_col = value,
#                               .condition_col = condition_class,
#                               .reference = "1",
#                               .degraded = "3") 

# For training dataset
long.df <- train.df %>% 
  pivot_longer(cols = c(-condition_class, -site_id),
               names_to = "metric",
               values_to = "value")

sens.df <- mmir::sensitivity(.dataframe = long.df,
                              .metric_col = metric,
                              .value_col = value,
                              .condition_col = condition_class,
                              .reference = "1",
                              .degraded = "3") 

DT::datatable(sens.df, options = list(scrollX = TRUE))

sensitive_mets.vec <- sens.df %>% 
  filter(barbour >= 2) %>% 
  # Shull et al., ,2019 uses >70%
  filter(de >= 65) %>%
  pull(metric)

# Creating training dataset
train_sensitive.df <- train.df %>% 
  select(condition_class, all_of(sensitive_mets.vec)) %>% 
  mutate(condition_class = as.character(condition_class))

# Creating cross-validation set. Comes into play later during validation...
train_10cv.df <- train_sensitive.df %>% 
  rsample::vfold_cv(v = 10, repeats = 1, strata = condition_class)


# Creating testing dataset
test_sensitive.df <- test.df %>% 
  select(condition_class, all_of(sensitive_mets.vec)) %>% 
  mutate(condition_class = as.character(condition_class))

test_10cv.df <- test_sensitive.df %>% 
  rsample::vfold_cv(v = 10, repeats = 1, strata = condition_class)

# Look at FFG metrics: "predator"  "gatherer"  "shredder"  "filterer"  "scraper"   "collector"
sens.df.ffg <- sens.df %>% 
  filter(grepl("predator|gatherer|shredder|filterer|scraper|collector", metric))

# write.csv(sens.df, file.path(root.dir, "data/metrics/june2021_rerun/metrics_sens_seed70_20210603.csv"))
# write.csv(sens.df.ffg, file.path(root.dir, "data/metrics/june2021_rerun/metrics_sens_seed70-FFG_20210603.csv"))

```


```{r Range filtering}

sens.df.subset <- train.df %>% 
  select(site_id, condition_class, all_of(sensitive_mets.vec))

# Find mins and maxes
sens.df.subset.range <- sens.df.subset %>%
  select(-condition_class) %>% 
  summarise_at(vars(-site_id), range) %>%
  rownames_to_column() %>%
  rename(summary_stat = rowname) %>% 
   mutate(summary_stat = case_when(
     summary_stat == 1 ~ "min",
     summary_stat == 2 ~ "max"))

# Transform, calculate ranges, and categorize
range <- sens.df.subset.range %>%
  gather(metric, value, -summary_stat) %>% 
  spread(summary_stat, value) %>% 
  mutate(range = max - min) %>%
  mutate(metric_type = case_when(
    grepl("pct", metric) ~ "pct",
    grepl("dom", metric) ~ "pct",
    grepl("rich", metric) ~ "rich",
    grepl("shannon", metric) ~ "div",
    grepl("margalef", metric) ~ "div",
    grepl("simpson", metric) ~ "div",
    grepl("pielou", metric) ~ "div",
    grepl("menhinick", metric) ~ "div",
    TRUE ~ "MISSING"
  )) 

# Drop pct metrics >10, richness >5, div >1 (as per Matt. Refs?)
rangefail.pct <- range %>% 
  filter(metric_type == "pct",
         range <  10)
rangefail.rich <- range %>% 
  filter(metric_type == "rich",
         range <  5)
rangefail.div <- range %>% 
  filter(metric_type == "div",
         range < 1)

metrics.drop.range <- bind_rows(rangefail.pct, rangefail.rich, rangefail.div) %>% 
  pull(metric) %>% 
  unique()

rm(rangefail.pct, rangefail.rich, rangefail.div)

# sens.df.subset.mean<-sens.df.subset %>%
#   select(-condition_class) %>% 
#   summarise_at(vars(-site_id), mean) %>%
#   rownames_to_column() %>%
#   rename(summary_stat=rowname) %>% 
#    mutate(summary_stat = case_when(
#      summary_stat== 1 ~ "mean"))
# 
# 
# sens.df.subset.IQR<-sens.df.subset %>%
#    filter(condition_class=="1") %>% 
#   select(-condition_class) %>% 
#   summarise_at(vars(-site_id), IQR) %>%
#   rownames_to_column() %>%
#   rename(summary_stat=rowname) %>% 
#    mutate(summary_stat = case_when(
#      summary_stat== 1 ~ "IQR"))
```



```{r Similarity across sites}
#Determine which metrics have >50% same values across all sites. Picks out metrics that have poor ability to differentiate btw sites.
  # Different from filtering by range b/c could have high range but many similar output values (poor differentiation). 
# Matt reference?

sens.df.subset.long <- sens.df.subset %>% 
  select(-condition_class) %>% 
  pivot_longer(!site_id, names_to = "metric", values_to = "value")

sens.df.rank <- sens.df %>% 
  unite("rank",metric, barbour, de, disturbance, sep = "_", remove = FALSE) %>% 
  select(rank, metric)

sens.df.subset.long <- left_join(sens.df.subset.long, sens.df.rank, by = c("metric"))

# sens.df.subset.wide<-sens.df.subset.long %>% 
#   select(-metric) %>% 
#   rename(metric=rank) %>% 
#   pivot_wider(names_from = metric, values_from = value)

sens.df.subset.long.round <- sens.df.subset.long %>% 
  mutate(value = case_when(
    str_detect(metric, "rich_") ~ round(value, digits = 0),
    str_detect(metric, "pct_") ~ ceiling(value),
    str_detect(metric, "shannon_") ~ round(value, digits = 1),
    str_detect(metric, "simpson_") ~ round(value, digits = 1),
    str_detect(metric, "margalef_") ~ round(value, digits = 1),
    str_detect(metric, "menhinick_") ~ round(value, digits = 1),
    str_detect(metric, "pielou_") ~ round(value, digits = 1),
    str_detect(metric, "dom_") ~  ceiling(value),
    TRUE ~ value
    
  ))

sens.df.subset.long.count <- sens.df.subset.long %>%
  group_by(metric, value) %>% 
  count(value) %>%
  ungroup() %>% 
  mutate(n_samples = 40) %>% 
  mutate(percent_similar = ((n/n_samples)*100)) %>% 
  group_by(metric, percent_similar) %>% 
  filter(percent_similar >= 50)

metrics.drop.sim <- sens.df.subset.long.count %>% 
  pull(metric)

# redund.metrics <-  sens.df.subset.long.count %>% 
#   pull(metric) %>% 
#   unique()
# cat(redund.metrics, sep = ", ")
```


Relative scope of impairment (SOI) looks at variability of metrics for ref sites. If varies by more than IQR, then potentially not a good metric bc too much variability among reference sites compared to the range of impairment.

Calculated as the ratio of the IQR of reference sites and the range of possible impairment (values beyond the poorer quality 25th percentile). Relative SOI values greater than 1 indicate too much variability among reference sites compared to the range of impairment. (See Blocksom 2002, 2009 (uses reverse equation))
```{r SOI}

# Take metrics that pass 1st screening, Filter to ref, combine metric name and predicted response (increase/decrease), take lower 25% for decrease, take top 75% for increase, take IQR

reference_sites <- sens.df.subset %>% 
  filter(condition_class == "1") %>% 
  select(site_id)
reference.vec <- c(reference_sites$site_id)

SOI.df <- sens.df.subset.long %>%
  filter(site_id %in% c(reference.vec)) %>% 
  group_by(metric) %>% 
  mutate(Q1 = case_when(
    str_detect(rank, "_decrease") ~ quantile(value, probs = 0.25),
    str_detect(rank, "_increase") ~ quantile(value, probs = 1),
    TRUE ~ value
  )) %>% 
  mutate(Q2 = case_when(
    str_detect(rank, "_decrease") ~ quantile(value, probs = 0),
    str_detect(rank, "_increase") ~ quantile(value, probs = 0.75),
    TRUE ~ value
  )) %>% 
  mutate(IQR = IQR(value)) %>% 
  ungroup() %>% 
  distinct(metric, Q1, Q2, IQR)

SOI.df <- SOI.df %>% 
  mutate(SOI = (IQR/(Q1 - Q2)))

metrics.drop.SOI <- SOI.df %>% 
  filter(SOI > 1) %>% 
  pull(metric)

# Investigating previously dropped metrics:
# metrics.drop.SOI_2 <- SOI.df %>% 
#   filter(SOI >= 1,
#          SOI <= 2) %>% 
#   pull(metric)
# 
# setdiff(metrics.drop.SOI_2, metrics.drop.SOI)
# setdiff(metrics.drop.SOI, metrics.drop.SOI_2)

```


# Metrics reduction stage 2

```{r Compile and remove underperforming metrics}

# Compile list of metrics to drop
metrics.drop <- c(metrics.drop.range, metrics.drop.SOI, metrics.drop.sim) %>% 
  unique()

train.df.sens <- train.df %>% 
  select(site_id, condition_class, all_of(sensitive_mets.vec), -all_of(metrics.drop)) 
    
```


```{r Redundancy by correlation, fig.width=8, fig.height=8}
library(corrr)

# Plot correlations of remaining metrics
# Bowman (yr?; GLIMPSS): "While there is no consensus on “hard cutoffs” for detecting metric redundancy, several workers have chosen r-values in excess of 0.75 (Maxted et al. 2000, Blocksom and Johnson 2009), 0.85 (Butcher et al. 2003, Gerritsen et al. 2000a), and 0.90 (Barbour et al. 1996) to screen for metric redundancy. For GLIMPSS development, we chose Pearson r-values of 0.75 as the cutoff"


corr.sens <- train.df.sens %>% 
  select(-condition_class, -site_id) %>% 
  correlate(use = "pairwise.complete.obs", method = "spearman") %>% 
  rearrange() %>% 
  shave()
corr.sens_rownames <- corr.sens %>%
  # mutate_all(~replace(., is.na(.), 1)) %>% 
  remove_rownames %>% 
  column_to_rownames(var = "term")  
corr.sens_highcorr <- corr.sens_rownames %>%
  abs() %>% 
  round(digits = 3) %>% 
  rownames_to_column() %>%
  # Remove values < 0.9
  mutate_all(funs(replace(., . <= 0.75, NA))) %>%
  # Remove columns and rows with all NAs
  column_to_rownames() %>% 
  purrr::discard(~all(is.na(.))) %>% 
  filter_all(any_vars(!is.na(.)))
ggcorrplot::ggcorrplot(corr.sens_rownames)

# Same as above for only cond class 1  (as per Shull et al. 2019)
corr.sens.cc1 <- train.df.sens %>% 
  filter(condition_class %in% "1") %>% 
  select(-condition_class, -site_id) %>% 
  correlate(use = "pairwise.complete.obs", method = "spearman") %>% 
  rearrange() %>% 
  shave()
corr.sens_rownames.cc1 <- corr.sens.cc1 %>%
  # mutate_all(~replace(., is.na(.), 1)) %>% 
  remove_rownames %>% 
  column_to_rownames(var = "term")  
corr.sens_highcorr.cc1 <- corr.sens_rownames.cc1 %>%
  abs() %>% 
  round(digits = 3) %>% 
  rownames_to_column() %>%
  # Remove values < 0.9
  mutate_all(funs(replace(., . <= 0.75, NA))) %>%
  # Remove columns and rows with all NAs
  column_to_rownames() %>% 
  purrr::discard(~all(is.na(.))) %>% 
  filter_all(any_vars(!is.na(.)))
ggcorrplot::ggcorrplot(corr.sens_rownames.cc1)



## LOOK AT SCATTERPLOTS OF THOSE W/ CORR'S ABOVE THRESHOLD to see if there are relationships other than linear (indicates duplicate metrics).
# Use psych package (see abiotic corr plots Rmd).

  # Shull et al. 2019: "Metrics with correlation coefficients > 0.75 were evaluated further by visually inspecting scatterplots. Candidate metrics with correlation coefficients > 0.75 and insufficient spread in the scatterplot were removed as candidate metrics."
 # Bowman: "...metric pairs approaching or slightly exceeding this value were further examined using scatterplots to see if nonlinear relationships were apparent or if there was sufficient dispersion (i.e., scatter) of the paired metric data points (Barbour et al. 1999). In this case, inclusion of both metrics could be beneficial to the multi-metric index."



```

```{r Table: highly correlated metrics}
DT::datatable(head(corr.sens_highcorr.cc1, 500), options = list(scrollX = TRUE))

```


```{r Filtered metric boxplots, fig.width=12, fig.height=18}

# train.df.sens.long <- train.df.sens %>% 
#   pivot_longer(!c(site_id, condition_class), names_to = "metric", values_to="value")
# 
# train.df.sens.long2 <- tidyr::gather(train.df.sens, metric, value, -site_id, -condition_class)  #%>% 
  # left_join(condition.df, by = "bas_loc_rm")


# Get list of filtered metrics to this point
metrics.filt <- train.df.sens %>% 
  select(-c(site_id, condition_class)) %>% 
  names() %>% 
  sort()

# metrics.filt_OLD <- train.df.sens_OLD %>% 
#   select(-c(site_id, condition_class)) %>% 
#   names() %>% 
#   sort()

# setdiff(metrics.filt, metrics.filt_OLD)


sens.df %>% 
  filter(metric %in% metrics.filt) %>%
  # filter(barbour == 3) %>% 
  arrange(metric) %>% 
  inner_join(long.df, by = "metric") %>% 
  mutate(metric = factor(metric, levels = unique(metric)),
         condition_class = factor(condition_class, levels = unique(condition_class))) %>% 
  ggplot(aes(condition_class, value)) +
  geom_boxplot() +
  facet_wrap(~metric, ncol = 4, scales = "free")

# sens.df %>% 
#   filter(metric %in% "rich_ffg") %>%
#   # filter(barbour == 3) %>% 
#   arrange(metric) %>% 
#   inner_join(long.df, by = "metric") %>% 
#   mutate(metric = factor(metric, levels = unique(metric)),
#          condition_class = factor(condition_class, levels = unique(condition_class))) %>% 
#   ggplot(aes(condition_class, value)) +
#   geom_boxplot() +
#   facet_wrap(~metric, ncol = 4, scales = "free")

```

```{r View sens table for filtered metrics, eval=TRUE}
sens.filt <- sens.df %>% 
  filter(metric %in% metrics.filt)

DT::datatable(head(sens.filt, 500), options = list(scrollX = TRUE))

# write.csv(sens.filt, file.path(root.dir, "data/metrics/june2021_rerun/sens.filt_seed60_2021-06-14.csv"))
```


# Final metrics boxplots

```{r Final metrics boxplots}

# Final set #1
# metrics.final <- c("dom_5_ttaxa", "pct_rich_ttaxa_cote", "rich_ttaxa_et", "rich_ttaxa_gatherer", "rich_ttaxa_intolerant", "shannon_ttaxa_toe")

# Final set #2 - Same as above removing pct_rich_ttaxa_cote, which is highly correlated with rich_taxa_et and shannon_taxa_toe.
# metrics.final <- c("dom_5_ttaxa", "rich_ttaxa_et", "rich_ttaxa_gatherer", "rich_ttaxa_intolerant", "shannon_ttaxa_toe")
    # results in 101 '0' metric scores. No metrics intercorr above 0.75.

# Final set #3 - Similar to above using more inclusive counterparts to see if results in <101 '0' metric scores.
# metrics.final <- c("dom_5_ttaxa", "rich_ttaxa_ept", "rich_ttaxa_gatherer", "rich_ttaxa_tol_0to7", "shannon_ttaxa_toe")
    # results in only 64 '0' metric scores. Better final IBI DE! Able to score more sites.
    # shannon_ttaxa_toe corr w rich_ttaxa_tol_0to7 at 0.77. But arguement to keep both, since different groups (one diversity, other tolerance/richness?)
    ### FINAL CHOSEN SET ###

# Final set #4 - Adding back in pct_rich_ttaxa_cote.
# metrics.final <- c("dom_5_ttaxa", "pct_rich_ttaxa_cote", "rich_ttaxa_ept", "rich_ttaxa_gatherer", "rich_ttaxa_tol_0to7", "shannon_ttaxa_toe")
    # No significant difference. (68 '0' metrics scores)

# Final set #5 - Subbing in even more inclusing metric with slighly lower DE's.
# metrics.final <- c("dom_5_ttaxa", "rich_ttaxa", "rich_ttaxa_gatherer", "rich_ttaxa_tol_0to7", "shannon_ttaxa_cote")
    # results in only 20 '0' metric scores!  BUT overall poorer DE.

# Final set #6 - Resample using "new" set.seed(80) subsample. New metrics chosen based on new training sensitivities.
# metrics.final <- c("dom_5_ttaxa", "pct_gatherer", "rich_ttaxa", "rich_ttaxa_toe", "rich_ttaxa_tol_0to7", "shannon_ttaxa_toe", "pct_rich_ttaxa_cte")

# Final set #7 
# metrics.final <- c("dom_5_ttaxa", "pct_gatherer", "rich_ttaxa", "pct_rich_ttaxa_toe", "rich_ttaxa_tol_0to7", "shannon_ttaxa_toe")

# Final set #8 - rich_ttaxa_tol_0to7 removed (high corr w 3 others)
# metrics.final <- c("dom_5_ttaxa", "pct_gatherer", "rich_ttaxa", "pct_rich_ttaxa_toe", "shannon_ttaxa_toe")

# Final set #9 - rich_ttaxa_tol_0to7 removed (high corr w 3 others)
# metrics.final <- c("dom_5_ttaxa", "shannon_ttaxa_shredder", "rich_ttaxa_tol_0to7", "rich_ttaxa_toe", "rich_ttaxa", "shannon_ttaxa_toe")
# metrics.final <- c("dom_5_ttaxa", "rich_ttaxa_tol_0to7", "rich_ttaxa_toe", "rich_ttaxa", "shannon_ttaxa_toe")
# metrics.final <- c("dom_5_ttaxa", "rich_ttaxa_tol_0to7", "rich_ttaxa", "shannon_ttaxa_toe")

# Final set #10 - 2 sites omitted and 4 reclasses
# set.seed 70
# metrics.final <- c("rich_ttaxa_insecta", "dom_3_ttaxa", "shannon_ttaxa_shredder", "shannon_ttaxa_cote")

# Final set #12 - 3 sites omitted, and 2 reclasses
# set.seed 70
# metrics.final <- c("rich_ttaxa_tol_0to7", "pct_rich_ttaxa_coe", "rich_ttaxa_toe", "shannon_ttaxa_shredder", "dom_4_ttaxa", "shannon_ttaxa_toe")
# metrics.final <- c("rich_ttaxa_tol_0to7",	"pct_rich_ttaxa_coe",	"rich_ttaxa_pote",	"shannon_ttaxa_shredder",	"dom_4_ttaxa",	"shannon_ttaxa_cte",	"shannon_ttaxa_pote")
# metrics.final <- c("rich_ttaxa_tol_0to7",	"pct_rich_ttaxa_coe",	"shannon_ttaxa_shredder",	"dom_4_ttaxa",	"shannon_ttaxa_pote")
# metrics.final <- c("rich_ttaxa_tol_0to7",	"rich_ttaxa_pote",	"shannon_ttaxa_shredder",	"dom_4_ttaxa",	"shannon_ttaxa_pote")

# set 13 - set.seed(80), 6/14/21
# metrics.final <- c("rich_ttaxa_tol_0to7", "pct_rich_ttaxa_insecta", "rich_ttaxa_cote", "pct_gatherer", "dom_4_ttaxa", "shannon_ttaxa_pote")
# metrics.final <- c("pct_rich_ttaxa_insecta", "pct_gatherer", "dom_4_ttaxa", "shannon_ttaxa_pote")

# set 14 - seed 5122, 6/14/21
# metrics.final <- c("rich_ttaxa_tol_0to7", "rich_ttaxa_insecta", "pct_rich_ttaxa_non_insecta", "menhinick_ttaxa", "shannon_ttaxa_coe", "pct_gatherer")
# metrics.final <- c("rich_ttaxa_tol_0to7", "rich_ttaxa_insecta", "menhinick_ttaxa", "shannon_ttaxa_coe", "pct_gatherer")

# set 15 - seed 60, 6/14/21
# metrics.final <- c("rich_ttaxa_tol_0to7", "rich_ttaxa_insecta", "pct_rich_ttaxa_non_insecta", "menhinick_ttaxa", "shannon_ttaxa_coe", "pct_gatherer")
# metrics.final <- c("rich_ttaxa_tol_0to7", "rich_ttaxa_coe", "rich_ttaxa_insecta", "shannon_ttaxa_shredder", "shannon_ttaxa_cte", "shannon_ttaxa_toe")
# metrics.final <- c("rich_ttaxa_tol_0to7", "rich_ttaxa_coe", "rich_ttaxa_insecta", "shannon_ttaxa_shredder", "shannon_ttaxa_cte")
# metrics.final <- c("rich_ttaxa_coe", "rich_ttaxa_insecta", "shannon_ttaxa_shredder", "shannon_ttaxa_cte", "shannon_ttaxa_toe",	"shannon_ttaxa_pote",	"shannon_ttaxa_et",	"shannon_ttaxa_ept", "shannon_ttaxa_coe", "shannon_ttaxa_cote", "shannon_ttaxa_potec")
metrics.final <- c("rich_ttaxa_coe", "rich_ttaxa_insecta", "shannon_ttaxa_shredder", "shannon_ttaxa_cte")

#plot final chosen metrics
# sens.df %>% 
#   filter(metric %in% metrics.final) %>%
#   arrange(metric) %>% 
#   inner_join(long.df, by = "metric") %>% 
#   mutate(metric = factor(metric, levels = unique(metric)),
#          condition_class = factor(condition_class, levels = unique(condition_class))) %>% 
#   ggplot(aes(condition_class, value)) +
#   geom_boxplot() +
#   facet_wrap(~metric, ncol = 4, scales = "free")

#plot final chosen metrics (same plot as above, didn't need sens.df)
long.df %>% 
  filter(metric %in% metrics.final) %>%
  arrange(metric) %>% 
  mutate(metric = factor(metric, levels = unique(metric)),
         condition_class = factor(condition_class, levels = unique(condition_class))) %>% 
  ggplot(aes(condition_class, value)) +
  geom_boxplot() +
  facet_wrap(~metric, ncol = 4, scales = "free")

# plot specific metrics
sens.df %>% 
  filter(metric %in% c("shannon_ttaxa_cte", "shannon_ttaxa_toe",	"shannon_ttaxa_pote",	"shannon_ttaxa_et",	"shannon_ttaxa_ept")) %>%
  arrange(metric) %>% 
  inner_join(long.df, by = "metric") %>% 
  mutate(metric = factor(metric, levels = unique(metric)),
         condition_class = factor(condition_class, levels = unique(condition_class))) %>% 
  ggplot(aes(condition_class, value)) +
  geom_boxplot() +
  facet_wrap(~metric, ncol = 5, scales = "free")

# sens.df %>% 
#   filter(metric %in% c("pct_plecoptera", "rich_ttaxa_plecoptera", "pct_rich_ttaxa_plecoptera", "shannon_ttaxa_plecoptera", "simpson_ttaxa_plecoptera")) %>%
#   # filter(barbour == 3) %>% 
#   arrange(metric) %>% 
#   inner_join(long.df, by = "metric") %>% 
#   mutate(metric = factor(metric, levels = unique(metric)),
#          condition_class = factor(condition_class, levels = unique(condition_class))) %>% 
#   ggplot(aes(condition_class, value)) +
#   geom_boxplot() +
#   facet_wrap(~metric, ncol = 4, scales = "free")

sens.final <- sens.df %>% 
  filter(metric %in% metrics.final)

# Export boxplots and sensitivites of the final metrics for the current run
# ggsave(file.path(root.dir, "data/ibi/reruns", "metrics_boxplots_seed60_20210616.png"), dpi = "screen")
# write_csv(sens.final, file.path(root.dir, "data/ibi/reruns/sens_final_seed80new_20210106.csv"))


```

```{r Corr plot for final metrics}

train.df.final <- train.df.sens %>% 
  select(site_id, condition_class, all_of(metrics.final))

### CREATE PLOTS USING PSYCH PACKAGE ###

corr.final.cc1 <- train.df.final %>% 
  filter(condition_class %in% "1") %>% 
  select(-condition_class, -site_id) %>% 
  correlate(use = "pairwise.complete.obs", method = "spearman") %>% 
  rearrange() %>% 
  shave()
corr.final_rownames.cc1 <- corr.final.cc1 %>%
  # mutate_all(~replace(., is.na(.), 1)) %>% 
  remove_rownames %>% 
  column_to_rownames(var = "term")  
tryCatch({
  corr.final_highcorr.cc1 <- corr.final_rownames.cc1 %>%
    abs() %>% 
    round(digits = 3) %>% 
    rownames_to_column() %>%
    # Remove values < 0.9
    mutate_all(funs(replace(., . <= 0.75, NA))) %>%
    # Remove columns and rows with all NAs
    column_to_rownames() %>% 
    purrr::discard(~all(is.na(.))) %>% 
    filter_all(any_vars(!is.na(.)))},
  error = function(e){cat("ERROR :",conditionMessage(e), "\n")}
)

ggcorrplot::ggcorrplot(corr.final_rownames.cc1)
```
# Metric corr w abiotic variables

```{r Metric corr w abiotic variables}
# Import sample dates for rejoining
sample.dates <- read_csv(file.path(root.dir, "data", "compile_2015-2019", "bugs", "2015-2019_lowgrad_bugs_UNIQUEdates_20210111.csv"))

# Import abiotic data (from PCA site classification script) and join sample dates
abiotic <- read_csv(file.path(root.dir, "data", "compile_2015-2019", "condition_classes", "LG_abiotic_pca_variables_20210112.csv")) %>% 
  left_join(sample.dates, by = "site_id") 
  # select(-sample_date, -uniqueid)

rm(sample.dates)

# Import chem data for 2017-2019 samples (does not exist for 2015 & 2016) and transform as needed
abiotic.chem <- read_csv(file.path(root.dir, "data/chemistry/2017-2019_chem_lowgrad_assoc_20210111.csv")) %>% 
  mutate(result_value = ifelse(lab_qualifiers %in% "U", 0, result_value),
         chemical_name = paste0(chemical_name, "_", result_unit)) %>% 
  filter(!is.na(result_value)) %>% 
  mutate(year = substr(sample_date, 3, 4),
    uniqueid = paste0(site_id, "_", year)) %>%
  select(-year) %>% 
  select(site_id, uniqueid, sample_date, chemical_name, result_value) %>% 
  group_by(site_id, chemical_name) %>% 
  spread(chemical_name, result_value) %>% 
# Only retain unique sites used in IBI dev (some were resampled in 2017-2019)
  filter(uniqueid %in% abiotic$uniqueid) %>% 
  select(-c(sample_date, uniqueid, "temperature of ph analysis_deg c", "conductivity at 25 degrees celsius_umhos/cm", "ph_pH units", "chlorophyll a_ug/l", "silver_ug/l"
            #  "nitrogen, kjeldahl, total", "nitrogen"
            )) %>% 
  filter(!(site_id %in% c(
    "17-PECN-12.4",
    "13-WALK-35.6",
    "13-IDNK-0.5")))

abiotic <- abiotic %>% 
  select(-sample_date, -uniqueid)


# train.df.sens.2 <- train.df.final %>% 
#   select(-condition_class)

# test.class2.df.cor <- test.class2.df %>% 
#   select(site_id, all_of(metrics.final))

# Abiotic param correlations w metrics (training)
# metrics.cor.abiotic<-left_join(train.df.final.2, abiotic, by=c("site_id"))
# metric.param.corr<-metrics.cor.abiotic %>% 
#   select(-site_id) %>% 
#   correlate(use = "pairwise.complete.obs", method = "spearman")
# metric.param.corr<-metric.param.corr %>% 
#   select(term, dom_5_ttaxa, pct_gatherer, rich_ttaxa, rich_ttaxa_toe, rich_ttaxa_tol_0to7, shannon_ttaxa_toe, pct_rich_ttaxa_cte) %>%
#   slice(8:14) %>% 
#   remove_rownames %>% 
#   column_to_rownames(var="term")  
# ggcorrplot::ggcorrplot(metric.param.corr)

# Abiotic param correlations w metrics (validation)
test.df.cor <- test.df %>% 
  select(site_id, all_of(metrics.final))

metrics.cor.abiotic<-left_join(test.df.cor, abiotic, by=c("site_id"))
metric.param.corr<-metrics.cor.abiotic %>% 
  select(-site_id) %>% 
  correlate(use = "pairwise.complete.obs", method = "spearman")
metric.param.corr<-metric.param.corr %>% 
  select(term, all_of(metrics.final)) %>%
  slice(8:14) %>% 
  remove_rownames %>% 
  column_to_rownames(var="term")  
ggcorrplot::ggcorrplot(metric.param.corr)

## Plot above w validation + class 2?

# Chemistry (independent dataset) correlations w metrics (all sites (44), final metrics)
chemsites.metrics.final <- metrics.df %>%
  select(site_id, all_of(metrics.final)) %>% 
  filter(site_id %in% abiotic.chem$site_id)

metrics.cor.chem<-left_join(chemsites.metrics.final, abiotic.chem, by=c("site_id"))
metric.param.corr.chem<-metrics.cor.chem %>% 
  select(-site_id) %>% 
  correlate(use = "pairwise.complete.obs", method = "spearman")
metric.param.corr.chem<-metric.param.corr.chem %>% 
  select(term, all_of(metrics.final)) %>% 
  slice(8:33) %>% 
  remove_rownames %>% 
  column_to_rownames(var="term")  
ggcorrplot::ggcorrplot(metric.param.corr.chem)

# Chemistry (independent dataset) correlations w metrics (training only; 17 site matches)
train.df.final.2 <- train.df.final %>%
  select(-condition_class)

metrics.cor.chem<-left_join(train.df.final.2, abiotic.chem, by=c("site_id"))
metric.param.corr.chem<-metrics.cor.chem %>% 
  select(-site_id) %>% 
  correlate(use = "pairwise.complete.obs", method = "spearman")
metric.param.corr.chem<-metric.param.corr.chem %>% 
  select(term, all_of(metrics.final)) %>%
  slice(8:33) %>% 
  remove_rownames %>% 
  column_to_rownames(var="term")  
ggcorrplot::ggcorrplot(metric.param.corr.chem)

# Chemisty param correlations w metrics (validation only; 5 SITES ONLY)
metrics.cor.chem<-left_join(test.df.cor, abiotic.chem, by=c("site_id"))
metric.param.corr.chem<-metrics.cor.chem %>%
  select(-site_id) %>%
  correlate(use = "pairwise.complete.obs", method = "spearman")
metric.param.corr.chem<-metric.param.corr.chem %>%
  select(term, all_of(metrics.final)) %>%
  slice(8:33) %>%
  remove_rownames %>%
  column_to_rownames(var="term")
ggcorrplot::ggcorrplot(metric.param.corr.chem)


# Chemistry (independent dataset) correlations w metrics (all sites, filtered metrics)
chemsites.metrics.filt <- metrics.df %>%
  select(site_id, all_of(metrics.filt)) %>% 
  filter(site_id %in% abiotic.chem$site_id)

metrics.cor.chem<-left_join(chemsites.metrics.filt, abiotic.chem, by=c("site_id"))
metric.param.corr.chem<-metrics.cor.chem %>% 
  select(-site_id) %>% 
  correlate(use = "pairwise.complete.obs", method = "spearman")
metric.param.corr.chem<-metric.param.corr.chem %>% 
  select(term, all_of(metrics.filt)) %>% 
  slice(35:53) %>% 
  remove_rownames %>% 
  column_to_rownames(var="term")  
ggcorrplot::ggcorrplot(metric.param.corr.chem)

# ggsave(file.path(root.dir, "data/metrics/abiotic_corr", "metrics_chem_corr_seed80new_filt_20210212.png"), dpi = "print")


# Look at cumulative correlations for each metric
metric.abiotic.corscore <- metric.param.corr %>% 
  abs()
colSums(metric.abiotic.corscore) %>% 
   knitr::kable()

# metric.chem.corscore <- metric.param.corr.chem %>% 
#   abs() %>% 
#   mutate(sum = rowSums(.))

metric.chem.corscore2 <- metric.param.corr.chem %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "metric") %>%
  mutate(corrscore = abs(rowSums(.[2:16]))) %>% 
  select(metric, corrscore, everything())

metric.chem.corscore3 <- metric.chem.corscore2 %>% 
  filter(metric %in% metrics.filt)

# colSums(metric.chem.corscore) %>% 
#    knitr::kable()

# write_csv(metric.chem.corscore2, file.path(root.dir, "data/metrics/abiotic_corr", "metrics_chem_corr_scores_20210113.csv"))


```


# Traditional IBI method

```{r Standardizing metrics}

metrics.df.standardized<-metrics.df %>%
   select(site_id, condition_class, all_of(metrics.final)) 

metrics.df.standardized.long<-metrics.df.standardized %>% 
  select(-condition_class) %>%
  pivot_longer(!site_id, names_to = "metric", values_to="value")

metrics.df.standardized.long <- left_join(metrics.df.standardized.long, sens.df, by=c("metric")) %>% 
  left_join(condition) 

#plot metrics before rescaling
metrics.df.standardized.long %>% 
  # left_join(condition) %>% 
  filter(metric %in% metrics.final) %>%
  arrange(metric) %>% 
  arrange(condition_class) %>% 
  mutate(metric = factor(metric, levels = unique(metric)),
         condition_class = factor(condition_class, levels = unique(condition_class))) %>% 
  ggplot(aes(condition_class, value)) +
  geom_boxplot() +
  facet_wrap(~metric, ncol = 4, scales = "free")

metrics.df.standardized.long.percentiles <-metrics.df.standardized.long %>%
  group_by(metric) %>% 
  mutate(Q_5th = quantile(value, probs = 0.05)) %>% 
  mutate(Q_95th =  quantile(value, probs = 0.95)) %>% 
  ungroup() %>% 
  mutate(SCORE = case_when(
    disturbance == "decrease" ~ ((value - Q_5th)/(Q_95th-Q_5th)),
    disturbance == "increase" ~ ((Q_95th - value)/(Q_95th-Q_5th)),
  )) %>% 
  mutate(SCORE = SCORE*10) %>% 
  select(site_id, metric, SCORE)

# Truncate Scores >10 to 10 and <0 to 0
metrics.df.standardized.long.percentiles$SCORE<-ifelse(metrics.df.standardized.long.percentiles$SCORE > 10, 10, metrics.df.standardized.long.percentiles$SCORE)
metrics.df.standardized.long.percentiles$SCORE<-ifelse(metrics.df.standardized.long.percentiles$SCORE <0, 0, metrics.df.standardized.long.percentiles$SCORE)

#plot rescaled metrics
metrics.df.standardized.long.percentiles %>% 
  left_join(condition) %>% 
  filter(metric %in% metrics.final) %>%
  arrange(metric) %>% 
  arrange(condition_class) %>% 
  mutate(metric = factor(metric, levels = unique(metric)),
         condition_class = factor(condition_class, levels = unique(condition_class))) %>% 
  ggplot(aes(condition_class, SCORE)) +
  geom_boxplot() +
  facet_wrap(~metric, ncol = 4, scales = "free")

metrics.scores<-metrics.df.standardized.long.percentiles %>% 
  pivot_wider(names_from = metric, values_from = SCORE)

# Use in console for pasting current final metrics in code below:
# cat(metrics.final, sep = ", ")

# Calculate final scores
metrics.scores<-metrics.scores %>%
  group_by(site_id) %>%
  mutate(SITE_SCORE = sum(c(rich_ttaxa_coe, rich_ttaxa_insecta, shannon_ttaxa_shredder, shannon_ttaxa_cte))) %>%
  mutate(SITE_SCORE = SITE_SCORE/4) %>%
  ungroup() %>%
  select(site_id, SITE_SCORE, rich_ttaxa_coe, rich_ttaxa_insecta, shannon_ttaxa_shredder, shannon_ttaxa_cte)

cond_class <- metrics.df %>% 
  select(site_id, condition_class)

metrics.scores <- left_join(metrics.scores, cond_class, by = c("site_id"))
metrics.scores <- metrics.scores

# Plot training
metrics.scores %>% 
  filter(site_id %in% c(train.df.vec)) %>% 
  mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>% 
  ggplot(aes(condition_class, SITE_SCORE)) +
  coord_cartesian(ylim = c(0, 10)) +
  geom_boxplot()
# ggsave(file.path(root.dir, "data/ibi/reruns", "lg_ibi_boxplot_set3_seed50-training.png"), dpi = "screen")

# Plot validation
metrics.scores %>% 
  filter(site_id %in% c(test.df.vec)) %>% 
  mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>% 
  ggplot(aes(condition_class, SITE_SCORE)) +
  coord_cartesian(ylim = c(0, 10)) +
  geom_boxplot()
# ggsave(file.path(root.dir, "data/ibi/reruns", "lg_ibi_boxplot_set3_seed50-val.png"), dpi = "screen")

metrics.scores.val <- metrics.scores %>% 
  filter(site_id %in% c(test.df.vec)) 


# Plot all (commented out bc not useful to plot training data alongside test data)
# metrics.scores %>% 
#   # filter(site_id %in% c(train.df.vec)) %>% 
#   mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>% 
#   ggplot(aes(condition_class, SITE_SCORE)) +
#   coord_cartesian(ylim=c(0, 100))+
#   geom_boxplot()

# Plot validation + class 2 (all data plotted minus training)
metrics.scores %>% 
  filter(!(site_id %in% train.df.vec)) %>%
  mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>% 
  ggplot(aes(condition_class, SITE_SCORE)) +
  coord_cartesian(ylim = c(0, 10)) +
  geom_boxplot()
ggsave(file.path(root.dir, "data/ibi/reruns/rescaling", "IBI_4met_seed60_2020-06-22_90-10_scaling_VAL.png"), dpi = "screen")
  
# metrics.scores %>%
#   filter(!(site_id %in% train.df.vec)) %>%
#   mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>%
#   ggplot(aes(condition_class, pct_gatherer)) +
#   coord_cartesian(ylim = c(0, 100)) +
#   geom_boxplot()


# plot all
metrics.scores %>%
  mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>%
  ggplot(aes(condition_class, SITE_SCORE)) +
  coord_cartesian(ylim = c(0, 10)) +
  geom_boxplot()
ggsave(file.path(root.dir, "data/ibi/reruns/rescaling", "IBI_4met_seed60_2020-06-22_90-10_scaling_ALL.png"), dpi = "screen")

metrics.scores.ref <- metrics.scores %>% 
  filter(site_id %in% c(train.df.vec)) %>% 
  filter(condition_class == "1") %>% 
  mutate(quant = quantile(SITE_SCORE, probs = 0.25))
metrics.scores.stress <- metrics.scores %>%
  filter(site_id %in% c(train.df.vec)) %>% 
  filter(condition_class == "3") %>% 
  mutate(quant = quantile(SITE_SCORE, probs = 0.75))

# write_csv(train.df, file.path(root.dir, "data/ibi/reruns", "lg_ibi_training_seed80new_2021-05-19.csv"))
```
# Rescaling final IBI for LGBAP scoring
```{r,eval=FALSE}

#Determine percentiles for classes 1 and 3
metrics.scores.c1train <- metrics.scores %>% 
  filter(!(site_id %in% train.df.vec)) %>%
  filter(condition_class %in% "1")
quantile(metrics.scores.c1train$SITE_SCORE, probs = c(0, 0.25, 0.5, 0.75, 1))
#       0%      25%      50%      75%     100% 
 # 24.98964  57.09333  68.58106  91.73102 100.00000 

metrics.scores.c3train <- metrics.scores %>% 
  filter(!(site_id %in% train.df.vec)) %>%
  filter(condition_class %in% "3")
quantile(metrics.scores.c3train$SITE_SCORE, probs = c(0, 0.25, 0.5, 0.75, 1))
 #      0%      25%      50%      75%     100% 
# 0.000000  6.002589 26.287092 34.825307 76.200409 

# Rescale using 25th percentile of class 3 as floor and 75th percentile of class 1 as ceiling.
metrics.scores.rescale <- metrics.scores %>% 
  mutate(SITE_SCORE_FINAL = (((SITE_SCORE - 6.002589  )/(91.73102   - 6.002589  )) * 10)) %>% 
  # Convert outer quartiles to 0 and 10 respectively
  mutate(SITE_SCORE_FINAL = ifelse(SITE_SCORE_FINAL > 10, 10, SITE_SCORE_FINAL)) %>% 
  mutate(SITE_SCORE_FINAL = ifelse(SITE_SCORE_FINAL < 0, 0, SITE_SCORE_FINAL)) 

# write_csv(metrics.scores.rescale, file.path(root.dir, "data/metrics/final_scores/metric_scores_all_lgbap_scaled_2021-05-19.csv"))


# Replot validation
metrics.scores.rescale %>% 
  filter(!(site_id %in% train.df.vec)) %>%
  mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>% 
  ggplot(aes(condition_class, SITE_SCORE_FINAL)) +
  coord_cartesian(ylim=c(0, 10))+
  geom_boxplot()
ggsave(file.path(root.dir, "data/ibi/reruns/rescaling", "IBI_4met_seed60_2020-06-22_VAL+cl2_double_scaling.png"), dpi = "screen")


# Plot all
metrics.scores.rescale %>% 
  # filter(!(site_id %in% train.df.vec)) %>%
  mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>% 
  ggplot(aes(condition_class, SITE_SCORE_FINAL)) +
  coord_cartesian(ylim=c(0, 10))+
  geom_boxplot()
ggsave(file.path(root.dir, "data/ibi/reruns/rescaling", "IBI_4met_seed60_2020-06-22_ALLDATA_double_scaling.png"), dpi = "screen")

```


# Exploring thresholds vs chem

```{r chem boxplots, fig.width=10, fig.height=12}

abiotic.chem.class <- abiotic.chem %>% 
  left_join(condition) %>% 
  select(site_id, condition_class, everything())

abiotic.chem.long <- abiotic.chem %>% 
  # filter(site_id %in% train.df$site_id) %>% 
  left_join(condition) %>% 
  pivot_longer(cols = c(-condition_class, -site_id),
               names_to = "chem",
               values_to = "value")  %>% 
  #Filter out 17-SWML-1.4 which has extremely high values for better visualization
  filter(!(site_id %in% "17-SWML-1.4"))

abiotic.chem.long %>% 
  mutate(chem = factor(chem, levels = unique(chem)),
         condition_class = factor(condition_class, levels = c("1", "2", "3"))) %>% 
  arrange(condition_class) %>%
  ggplot(aes(condition_class, value)) +
  geom_boxplot() +
  facet_wrap(~chem, ncol = 4, scales = "free")

```

```{r IBI scores vs stressor gradient variables}

fielddata <- read_csv(file.path(root.dir, "data/compile_2015-2019/field_data/2015-2019_LG_field_landcover_condclasses_20201216.csv")) %>% 
  left_join(metrics.scores, by = "site_id") %>% 
  select(site_id, condition_class.x, habitat_total_score, landcover_nat_pct, spcond, SITE_SCORE, PC1)
fielddata %>% 
  ggplot(aes(x=SITE_SCORE, y=spcond)) + 
  geom_point() +
  geom_smooth(method=lm)
 fielddata %>% 
  ggplot(aes(x=SITE_SCORE, y=landcover_nat_pct)) + 
  geom_point() +
  geom_smooth(method=lm)
 fielddata %>% 
  ggplot(aes(x=SITE_SCORE, y=habitat_total_score)) + 
  geom_point() +
  geom_smooth(method=lm)
fielddata %>% 
  ggplot(aes(x=SITE_SCORE, y=PC1)) + 
  geom_point() +
  geom_smooth(method=lm)

# Plotting with rescaled IBI scores (validation only)
fielddata <- read_csv(file.path(root.dir, "data/compile_2015-2019/field_data/2015-2019_LG_field_landcover_condclasses_20201216.csv")) %>% 
  left_join(metrics.scores.rescale, by = "site_id") %>% 
  filter(!(site_id %in% train.df.vec)) %>%
  select(site_id, condition_class.x, habitat_total_score, landcover_nat_pct, spcond, SITE_SCORE_FINAL, PC1)
fielddata %>% 
  ggplot(aes(x=SITE_SCORE_FINAL, y=spcond)) + 
  geom_point() +
  geom_smooth(method=lm)
 fielddata %>% 
  ggplot(aes(x=SITE_SCORE_FINAL, y=landcover_nat_pct)) + 
  geom_point() +
  geom_smooth(method=lm)
 # fielddata %>% 
 #  ggplot(aes(x=SITE_SCORE_FINAL, y=habitat_total_score)) + 
 #  geom_point() +
 #  geom_smooth(method=lm)
fielddata %>% 
  ggplot(aes(x=SITE_SCORE_FINAL, y=PC1)) + 
  geom_point() +
  geom_smooth(method=lm)
```






##### END TRADITIONAL IBI SECTION #####




#Training and Logistical Regression model

```{r Data prep and model creation}

# Packages at https://www.tidymodels.org/

# Create recipe object
rec_obj <- train_sensitive.df %>% 
  select(condition_class, all_of(metrics.final)) %>% 
  recipe(condition_class ~ ., data = .) %>% 
  # update_role(uniqueid, new_role = "sample_id") %>%
  step_normalize(all_predictors()) %>% 
 # step_nzv(all_predictors()) %>%
 # step_corr(all_predictors(),
  #          threshold = 0.5) %>%
 # step_pca(all_predictors()) %>%
  themis::step_smote(condition_class)
  # step_smote creates a specification of a recipe step that generate new examples of the minority class using nearest neighbors of these cases.
  # Matt says step_smote is redundant if already balanced btw test and ref sites... but removing does not result in an identical DF!


# Extract finalized training set (juice function). Specifiy params for log regr. and engine.

train.juice <- rec_obj %>% 
  prep(training = train_sensitive.df) %>% 
  juice()

logit_mod <- logistic_reg() %>%
  set_engine("stan")

met.flow <- workflow() %>% 
  add_recipe(rec_obj) %>% 
  add_model(logit_mod)

# Provisional set # 1 - Outputs weighting coefficients of metrics used... margalef_ttaxa heavily weighted!!!
(fit_train <- fit(met.flow, data = train_sensitive.df))

```


```{r Cross validation and measuring performace}

# Cross validation tutorial: https://www.youtube.com/watch?v=fSytzGwwBVw 

library(tune)
library(yardstick)

# Training

control <- control_resamples(save_pred = FALSE)
metrics <- metric_set(roc_auc, bal_accuracy, pr_auc)

spline_res <- fit_resamples(logit_mod, rec_obj, train_10cv.df,
                            metrics = metrics,
                            control = control)

show_best(spline_res, metric = "roc_auc")
show_best(spline_res, metric = "bal_accuracy")
show_best(spline_res, metric = "pr_auc")

# Output scores (mean) of 1 would be 100% accurate classification. Zach says anything >75 acceptible (reference?).


# Validation (using test dataset) - dont need bc doing independent validation in confusion matrix below.

control <- control_resamples(save_pred = FALSE)
metrics <- metric_set(roc_auc, bal_accuracy, pr_auc)

spline_res <- fit_resamples(logit_mod, rec_obj, test_10cv.df,
                            metrics = metrics,
                            control = control)

show_best(spline_res, metric = "roc_auc")
show_best(spline_res, metric = "bal_accuracy")
show_best(spline_res, metric = "pr_auc")

```

```{r Create logistical regression model}

test.df <- testing(train_test_split) %>% 
  filter(condition_class %in% c("1", "3")) %>% 
   select(condition_class, all_of(metrics.final))

#Training
pred_test <- predict(fit_train, new_data = train_sensitive.df, type = "prob") %>% 
  bind_cols(select(train_sensitive.df, condition_class))

# Validation (don't need this bc doing independent validation in confusion matrix below.)
pred_test_validation <- predict(fit_train, new_data = test.df, type = "prob") %>% 
  bind_cols(select(test.df, condition_class))
pred_test_all <- predict(fit_train, new_data = metrics.df, type = "prob") %>% 
  bind_cols(select(metrics.df, condition_class))


```


```{r Logistical regression model plots}

# Training

pred_test %>% 
  # filter(condition_class %in% c("1", "4")) %>% 
  mutate(condition_class = as.character(condition_class)) %>% 
  mutate(condition = case_when(
    condition_class %in% "3" ~ 1,
    condition_class %in% "1" ~ 0,
    TRUE ~ 9999
  )) %>% 
ggplot(aes(.pred_1, condition)) +
  geom_point() +
  stat_smooth(method="glm", se=FALSE, method.args = list(family=binomial)) 

# Validation (not needed; just plotting for visual comparison)

pred_test_validation %>% 
  # filter(condition_class %in% c("1", "4")) %>% 
  mutate(condition_class = as.character(condition_class)) %>% 
  mutate(condition = case_when(
    condition_class %in% "3" ~ 1,
    condition_class %in% "1" ~ 0,
    TRUE ~ 9999
  )) %>% 
ggplot(aes(.pred_1, condition)) +
  geom_point() +
  stat_smooth(method="glm", se=FALSE, method.args = list(family=binomial)) 

#All Data (not needed; just plotting for visual comparison)

pred_test_all %>% 
  filter(condition_class %in% c("1", "3")) %>% 
  mutate(condition_class = as.character(condition_class)) %>% 
  mutate(condition = case_when(
    condition_class %in% "3" ~ 1,
    condition_class %in% "1" ~ 0,
    TRUE ~ 9999
  )) %>% 
ggplot(aes(.pred_1, condition)) +
  geom_point() +
  stat_smooth(method="glm", se=FALSE, method.args = list(family=binomial)) 

```

```{r Visualize model performance (ROC curve)}

# Receiver operator curve
# Add in resampling as shown at https://yardstick.tidymodels.org/ ?
# Look up sensitivity vs specificity

# Training
# Goal is for model to have high sensitivity ("curve" tighter to top left corner). 


simple_glm_roc <- pred_test %>% 
  roc_curve(factor(condition_class), .pred_1)
# computes the area under the ROC curve
pred_test_validation %>% 
  roc_auc(factor(condition_class), .pred_1)
autoplot(simple_glm_roc)


# Validation (not needed?; just plotting for visual comparison)

simple_glm_roc <- pred_test_validation %>% 
  roc_curve(factor(condition_class), .pred_1)
pred_test_validation %>% 
  roc_auc(factor(condition_class), .pred_1)
autoplot(simple_glm_roc)



```

## Probilities from log regr. for each class - Summary of results!

```{r Log regr boxplot}


# ***Training***

train.df <- predict(fit_train, new_data = training(train_test_split), type = "prob") %>% 
  bind_cols(select(training(train_test_split), condition_class))

train.df %>% 
  mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>% 
ggplot(aes(condition_class, .pred_1)) +
  geom_boxplot()

#Validation

test.df <- predict(fit_train, new_data = testing(train_test_split), type = "prob") %>% 
  bind_cols(select(testing(train_test_split), condition_class, site_id))

test.df %>% 
  mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>% 
ggplot(aes(condition_class, .pred_1)) +
  geom_boxplot()

#All Data 

all.df <- predict(fit_train, new_data = metrics.df, type = "prob") %>% 
  bind_cols(select(metrics.df, condition_class, site_id))

all.df %>% 
  mutate(condition_class = factor(condition_class, c("1", "2", "3"))) %>% 
ggplot(aes(condition_class, .pred_1)) +
  geom_boxplot()

### LOOK AT OUTLIERS
all.df.outliers.cl3 <- all.df %>% 
  filter(condition_class == 3,
         .pred_1 > 0.5) %>% 
  pull(site_id)

all.df.outliers.cl1 <- all.df %>% 
  filter(condition_class == 1,
         .pred_1 < 0.25) %>% 
  pull(site_id)

outliers.all <- c(all.df.outliers.cl3, all.df.outliers.cl1) %>% 
  cat(sep = "\n")



```

```{r, confusion matrix accuracy assessment for validation dataset}

test.df <- predict(fit_train, new_data = testing(train_test_split), type = "prob") %>% 
  bind_cols(select(testing(train_test_split), condition_class, site_id))

# Assign prediction probabilities 
test.df.confuse<-test.df %>% 
  mutate(condition_class = factor(condition_class, c("1","3"))) %>%
  filter(condition_class %in% c("1","3")) %>% 
  mutate(prediction = case_when(
    .pred_1>0.5 ~ "1",
    .pred_1<0.5 ~ "3",
  )) %>% 
  rename(truth = condition_class) %>% 
  mutate(prediction = factor(prediction, c("1","3")))
  

test.df.confuse %>%
  conf_mat(truth, prediction) %>%
  summary() %>%
  filter(.metric %in%
    c("accuracy", "precision", "recall", "f_meas")) %>%
  as_tibble()
  
```
