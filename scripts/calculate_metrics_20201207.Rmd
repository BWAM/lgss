---
title: "calculate_metrics_20201207"
output: html_document
---

```{r Load libs}
library(tidyverse)
library(mmir)

root.dir <- rprojroot::find_root("lgss.Rproj")
datamod.dir <- file.path("C:/Users/gmlemley/New York State Office of Information Technology Services/SMAS - Streams Data Modernization/Cleaned Files/FINAL_RELOADS_SEPT2020")

```

```{r Taxa table prep}
# Load master taxa table
master.taxa <- read.csv(file.path(datamod.dir, "Final_Macro_ITS", "20201019_S_MSTR_MACRO_SPECIES.csv"), stringsAsFactors = FALSE, na.strings = c("", "NA")) %>% 
  rename_all(tolower) %>% 
  setNames(., sub("mms_", "", names(.)))

# May need to rename columns to match original attributes table used:
# names(attributes.df)
#  [1] "final_id"         "macro_genspecies" "tol_int"          "tol_char"         "tol_p_int"        "tol_n_int"        "ffg"              "reference"       
#  [9] "prevnames"        "final_tsn"        "final_id.y"       "kingdom"          "subkingdom"       "infrakingdom"     "superphylum"      "phylum"          
# [17] "subphylum"        "class"            "subclass"         "infraclass"       "superorder"       "order"            "suborder"         "infraorder"      
# [25] "superfamily"      "family"           "subfamily"        "tribe"            "subtribe"         "genus"            "subgenus"         "species"         
# [33] "subspecies"       "org_id"  

# Load bug matrix
taxa.df.wide <- read.csv(file.path(root.dir, "data/compile_2015-2019/bugs/2015-2019_lowgrad_bugs_matrix_UNIQUE_20201207.csv"), check.names = FALSE)

# List taxa names for troublshooting
# bugnames <- as.data.frame(names(taxa.df)) %>% 
#   rename(genspecies = "names(taxa.df)") %>% 
#   filter(!grepl("site_id", genspecies))

# Convert from wide to long
taxa.df <- taxa.df.wide %>% 
  gather(final_id, count, -site_id) %>% 
  filter(!is.na(count),
         count > 0)  

# Identify missing taxa
missing.df <- taxa.df %>% 
  select(final_id) %>% 
  distinct() %>% 
  anti_join(master.taxa, by = c("final_id" = "macro_genspecies"))

# Join attributes to data
taxa.df <- taxa.df %>% 
  rename(macro_genspecies = final_id) %>%
  left_join(master.taxa, by = "macro_genspecies") #%>% 
  # fill_taxa(taxa.df, final_id, kingdom:subspecies)

# Attach disturbance categories and remove data without a class
condition <- read.csv(file.path("C:/Data/LGSS_scripting/lgss/data/compile_2015-2019/condition_classes", "2015-2019_LG_condclasses_20201203.csv"))
taxa.df <- taxa.df %>% left_join(., condition) %>% 
  select(site_id, condition_class, everything()) %>% 
  filter(!is.na(condition_class))

# Create target_taxon field
# taxa.df <- taxa.df %>%
#   mutate(target_taxon = ifelse(genus != "", genus,
#                                ifelse( # ENTER NEXT TAXA RANK HERE...  ))) %>%
#   select(site_id, target_taxon, everything())

rm(missing.df, taxa.df.wide, condition)
```


fill_taxa() function
```{r eval = FALSE}
#'Fill NAs with Previous Taxonomic Rank
#'@description Fill in NA values present in the taxonomic hierarchy with the
#'previous taxonomic rank.
#'@param long.df Taxonomic counts arranged in a long data format.
#'@param final.id.col The name of the column that contains the final taxonomic
#'ID.
#'@param ... A set of columns related to taxonomic ranks where NA
#'values will be replaced with the previous taxonomic rank. It is important to
#'list these columns in the appropriate order (e.g. phylum to species). The
#'order the columns are presented is used to create the hierarchy that
#'identifies the previous taxonomic rank.
#'@return A data frame.
#'@export
fill_taxa <- function(long.df, final.id.col, ...) {
  rank.quos <- rlang::quos(...)
  final.id.col <- rlang::enquo(final.id.col)
  rank.vec <- long.df %>%
    dplyr::select(!!!rank.quos) %>%
    names()
  final.df <- long.df %>%
    tidyr::gather(rank, taxon, !!!rank.quos) %>%
    dplyr::mutate(rank = factor(rank, levels = rank.vec),
                  taxon = if_else(taxon == "", as.character(NA), taxon)) %>%
    dplyr::group_by(!!final.id.col) %>%
    tidyr::fill(taxon)  %>%
    dplyr::ungroup() %>%
    tidyr::spread(rank, taxon)
  return(final.df)
}

master.taxa.fill <- Benthos::fill_taxa(master.taxa)


```


# Calculate metrics


## Richness Metrics

### Community Richness
```{r}

# Spot-checked okay

nest.df <- taxa.df %>%
  dplyr::group_nest(site_id,  condition_class, .key = "data")

rich.df <- nest.df %>%
  dplyr::mutate(
    rich_family = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = family,
                            .unnest_col = data,
                            .filter = !is.na(family)),
    rich_genus = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = genus,
                            .unnest_col = data,
                            .filter = !is.na(genus))
  )


rich.df %>%
  dplyr::mutate(data = "nested dataframe") %>%
  head() %>%
  knitr::kable()

```

### Subgroup Richness
```{r}

#### If not using taxa_fill(), need to add .filter = !is.na(family)), etc.
# How to add more than one statement to filter argument? Tried c() and && (neither work).
# Example - 04-MCMI_S-5.0 should be 4/5/12 but it's 4/6/13.

sub_rich.df <- nest.df %>%
  dplyr::mutate(
    rich_ephemeroptera_fam = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = family,
                            .filter = order %in% "ephemeroptera",
                            .unnest_col = data),
    rich_ephemeroptera_gen = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = genus,
                            .filter = order %in% "ephemeroptera",
                            .unnest_col = data),
    rich_ept_gen = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = genus,
                            .filter = order %in% c("ephemeroptera",
                                                       "plecoptera",
                                                       "trichoptera"),
                            .unnest_col = data)
  )

sub_rich.df %>%
  dplyr::mutate(data = "nested dataframe") %>%
  head() %>%
  knitr::kable()
```


## Diversity Metrics

### Community Diversity

```{r}

### Not spot-checked

div.df <- nest.df %>%
  dplyr::mutate(
    shannon_genus = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = genus,
                            .job = "shannon",
                             .base_log = 2,
                            .unnest_col = data),
    simpson_genus = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = genus,
                            .job = "simpson",
                            .unnest_col = data),
    margalef_genus = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = genus,
                            .job = "margalef",
                            .unnest_col = data),
    menhinick_genus = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = genus,
                            .job = "menhinick",
                            .unnest_col = data),
    pielou_genus = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = genus,
                            .job = "pielou",
                            .unnest_col = data)
  )

div.df %>%
  dplyr::mutate(data = "nested dataframe") %>%
  head() %>%
  knitr::kable()
```

### Subgroup Diversity

```{r}

### Not spot-checked

sub_div.df <- nest.df %>%
  dplyr::mutate(
    gini_simpson_ept = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = order,
                            .filter = order %in% c("ephemeroptera",
                                                       "plecoptera",
                                                       "trichoptera"),
                            .job = "gini_simpson",
                            .unnest_col = data),
    simpson_ept = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = order,
                            .filter = order %in% c("ephemeroptera",
                                                       "plecoptera",
                                                       "trichoptera"),
                            .job = "simpson",
                            .unnest_col = data),
    shannon_ept = taxa_div(.dataframe = .,
                            .key_col = site_id,
                            .counts_col = count,
                            .group_col = order,
                            .filter = order %in% c("ephemeroptera",
                                                       "plecoptera",
                                                       "trichoptera"),
                            .job = "shannon",
                            .base_log = 2,
                            .unnest_col = data)
  )

sub_div.df %>%
  dplyr::mutate(data = "nested dataframe") %>%
  head() %>%
  knitr::kable()
```

### Dominance

```{r}

#### Need to generate target_taxon field before running this 
#### OR use taxa_fill() instead?

# dom.df <- nest.df %>%
#   dplyr::mutate(
#     dom_1_target_taxon = taxa_dom(.dataframe = .,
#                                   .key_col = site_id,
#                                   .counts_col = count,
#                                   .group_col = target_taxon,
#                                   .dom_level = 1,
#                                   .unnest_col = data),
#     dom_5_target_taxon = taxa_dom(.dataframe = .,
#                                   .key_col = site_id,
#                                   .counts_col = count,
#                                   .group_col = target_taxon,
#                                   .dom_level = 5,
#                                   .unnest_col = data)
#   )
# 
# dom.df %>%
#   dplyr::mutate(data = "nested dataframe") %>%
#   head() %>%
#   knitr::kable()
```


### Community Metrics

## Percentages

```{r}

# Spot-checked okay

pct.df <- nest.df %>%
  dplyr::mutate(
    pct_ephemeroptera = taxa_pct(.dataframe = .,
                                  .key_col = site_id,
                                  .counts_col = count,
                                  .filter = order %in% "ephemeroptera",
                                 .unnest_col = data),
    pct_ept = taxa_pct(.dataframe = .,
                        .key_col = site_id,
                        .counts_col = count,
                        .filter = order %in% c("ephemeroptera",
                                                   "plecoptera",
                                                   "trichoptera"),
                       .unnest_col = data)
  )

pct.df %>%
  dplyr::mutate(data = "nested dataframe") %>%
  head() %>%
  knitr::kable()

```


## Abundances

```{r}

# Spot-check okay

abund.df <- nest.df %>%
  dplyr::mutate(
    abund_ephemeroptera = taxa_abund(.,
                                  .key_col = site_id,
                                  .counts_col = count,
                                  .filter = order %in% "ephemeroptera",
                                  .unnest_col = data),
    abund_ept = taxa_abund(.,
                        .key_col = site_id,
                        .counts_col = count,
                        .filter = order %in% c("ephemeroptera",
                                                   "plecoptera",
                                                   "trichoptera"),
                        .unnest_col = data)
  )

abund.df %>%
  dplyr::mutate(data = "nested dataframe") %>%
  head() %>%
  knitr::kable()

```


## Testing example code for Sequencing Metric Calculations

```{r}
seq.df <- nest.df %>%
  dplyr::bind_cols(
    taxa_seq(.dataframe = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class", "order"),
             .group_col = genus,
             .job = "rich",
             .unnest_col = data)
    )

dplyr::tibble(
  "List of Column Names" = names(seq.df)
) %>%
knitr::kable()
```


## Testing "Putting it All Together" example

```{r}

### Need field target_taxon use use fill_taxa() in order to run code below ###

metrics.df <- nest.df %>%
  dplyr::mutate(
    rich_family = taxa_rich(.dataframe = .,
                            .key_col = site_id,
                            .group_col = family,
                            .unnest_col = data),
    rich_genus = taxa_rich(.dataframe = .,
                           .key_col = site_id,
                           .group_col = genus,
                           .unnest_col = data),
    rich_target_taxon = taxa_rich(.dataframe = .,
                                  .key_col = site_id,
                                  .group_col = target_taxon,
                                  .unnest_col = data),
    gini_simpson_ept = taxa_div(.dataframe = .,
                                .key_col = site_id,
                                .counts_col = count,
                                .group_col = target_taxon,
                                .filter = order %in% c("ephemeroptera",
                                                       "plecoptera",
                                                       "trichoptera"),
                                .job = "gini_simpson",
                                .unnest_col = data),
    simpson_ept = taxa_div(.dataframe = .,
                           .key_col = site_id,
                           .counts_col = count,
                           .group_col = target_taxon,
                           .filter = order %in% c("ephemeroptera",
                                                  "plecoptera",
                                                  "trichoptera"),
                           .job = "simpson",
                           .unnest_col = data),
    shannon_ept = taxa_div(.dataframe = .,
                           .key_col = site_id,
                           .counts_col = count,
                           .group_col = target_taxon,
                           .filter = order %in% c("ephemeroptera",
                                                  "plecoptera",
                                                  "trichoptera"),
                           .job = "shannon",
                           .base_log = 2,
                           .unnest_col = data),
    pct_ept = taxa_pct(.dataframe = .,
                       .key_col = site_id,
                       .counts_col = count,
                       .filter = order %in% c("ephemeroptera",
                                              "plecoptera",
                                              "trichoptera"),
                       .unnest_col = data),
    pct_cote = taxa_pct(.dataframe = .,
                        .key_col = site_id,
                        .counts_col = count,
                        .filter = order %in% c("coleoptera",
                                               "odonata",
                                               "trichoptera",
                                               "ephemeroptera"),
                        .unnest_col = data),
    dom_1_target_taxon = taxa_dom(.dataframe = .,
                                  .key_col = site_id,
                                  .counts_col = count,
                                  .group_col = target_taxon,
                                  .dom_level = 1,
                                  .unnest_col = data),
    dom_5_target_taxon = taxa_dom(.dataframe = .,
                                  .key_col = site_id,
                                  .counts_col = count,
                                  .group_col = target_taxon,
                                  .dom_level = 5,
                                  .unnest_col = data),
    tol_index = taxa_tol_index(.dataframe = .,
                               .key_col = site_id,
                               .counts_col = count,
                               .tol_col = ptv,
                               .unnest_col = data)
  ) %>%
  dplyr::bind_cols(
    taxa_seq(.dataframe = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class", "order", "family"),
             .group_col = target_taxon,
             .job = "rich",
             .unnest_col = data),
    taxa_seq(.dataframe = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class", "order", "family"),
             .group_col = target_taxon,
             .job = "pct_rich",
             .unnest_col = data),
    taxa_seq(.dataframe = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class", "order", "family", "genus"),
             .job = "pct",
             .unnest_col = data),
    taxa_seq(.dataframe = .,
             .key_col = site_id,
             .counts_col = count,
             .filter_cols_vec = c("class", "order", "family"),
             .group_col = target_taxon,
             .job = "simpson",
             .unnest_col = data),
  )
```


```{r}
lowgrad_metrics.df <- metrics.df %>%
  dplyr::select(-data)

usethis::use_data(lowgrad_metrics.df,
                  overwrite = TRUE)
```






## Running mmir example data
```{r Load in data}
data("nrsa_nap_0809", package = "mmir")

test.nest.df <- nrsa_nap_0809 %>%
  dplyr::group_nest(uid,  rt_nrsa_cat, .key = "data")


test.rich.df <- test.nest.df %>%
  dplyr::mutate(
    rich_family = taxa_rich(.dataframe = .,
                            .key_col = uid,
                            .group_col = family,
                            .unnest_col = data),
    rich_genus = taxa_rich(.dataframe = .,
                            .key_col = uid,
                            .group_col = genus,
                            .unnest_col = data)
  )


test.rich.df %>%
  dplyr::mutate(data = "nested dataframe") %>%
  head() %>%
  knitr::kable()
```

