---
title: "compile_2015-19"
author: "Gavin Lemley"
date: "3/31/20"
output: html_document
---

Find the R-project root directory to simplify file path designations.
```{r}
library(tidyverse)
library(readxl)

root.dir <- rprojroot::find_root("lgss.Rproj")

```

Load in ITS data tables, subset, and add fields
### NOT USING B/C MUCH LG DATA MISSING FROM ITS TABLES ###
```{r}

# Load joined data from Keleigh
bugs.all <- read_csv(file.path(root.dir, "data/2015-2019", "raw.macrolab.gavin.csv")) %>% 
  mutate(COLL_DATE_T = as.Date(COLL_DATE_T, format = "%m/%d/%Y")) %>%
  filter(COLLECT == 9) %>%
  mutate(SITE_ID = sub('_[^_]*$', '', EVENT_ID)) 

# Load macro species data table submitted to ITS
macrodata.ITS <- read_csv(file.path(root.dir, "data/2015-2019/ITS_tables_03-31-2020", "S_MACRO_SPECIES_DATA_HISTORY.csv")) %>% 
  mutate(SITE_ID = sub('_[^_]*$', '', EVENT_ID)) %>% 
  mutate(SAMPLE_DATE = sub('.*\\_', '', EVENT_ID)) %>% 
  mutate(SAMPLE_DATE = as.Date(SAMPLE_DATE, format = "%Y%m%d")) 

# Load macro sample info table submitted to ITS
macroinfo.ITS <- read_csv(file.path(root.dir, "data/2015-2019/ITS_tables_03-31-2020", "S_MACRO_SPECIES_SAMP_INF_HIST.csv")) %>% 
  # filter(BIOSAMPLE_COLLECT_METHOD_ID == 9) %>%
  mutate(SITE_ID = sub('_[^_]*$', '', EVENT_SMAS_ID)) %>% 
  mutate(SAMPLE_DATE = sub('.*\\_', '', EVENT_SMAS_ID)) %>% 
  mutate(SAMPLE_DATE = as.Date(SAMPLE_DATE, format = "%Y%m%d")) %>% 

# Load macro field data table submitted to ITS
field.macro.ITS <- read_csv(file.path(root.dir, "data/2015-2019/ITS_tables_03-31-2020", "S_MACRO_FIELD_DATA_2020_03_30.csv")) 
# %>% 
#   filter(bugs.all$EVENT_ID %in% EVENT_ID)

# Load field sampling event info table submitted to ITS
field.eventinfo.ITS <- read_csv(file.path(root.dir, "data/2015-2019/ITS_tables_03-31-2020", "S_SAMPLE_EVENT_INFO_2020_03_30.csv"))

# Load habitat survey table submitted to ITS
field.habitat.ITS <- read_csv(file.path(root.dir, "data/2015-2019/ITS_tables_03-31-2020", "S_HABITAT_FIELD_DATA_2020_03_13.csv"))

#Load master sites table
sites.master <- read_csv(file.path(root.dir, "data/2015-2019", "20191224_Site_Field_cleaned_final.csv"))


```

Assessing ITS tables for missing LG data
```{r}
macroinfo.ITS <- macroinfo.ITS %>% 
  mutate(YEAR = format(as.Date(SAMPLE_DATE, format="%m/%d/%Y"),"%Y"))

macroinfo.ITS.2018 <- macroinfo.ITS %>% 
  filter(YEAR == "2018") 

macroinfo.ITS.LG <- macroinfo.ITS %>% 
  filter(BIOSAMPLE_COLLECT_METHOD_ID == 9)

macroinfo.ITS.LG.count <- macroinfo.ITS.LG %>% 
  select(SITE_ID, YEAR) %>% 
  distinct() %>% 
  select(YEAR) 
table(macroinfo.ITS.LG.count)




```


Format data further for sending to TetraTech
```{r}
# tt.bugs.all <- read_csv(file.path(root.dir, "data/2015-2019", "raw.macrolab.gavin.csv")) %>% 
#   select(-c(X1, LOCATION, BASIN, RIVMILE, COLL_DATE_D, SITE_LOC_ID, BASIN_T, RIVMILE_T, COLL_DATE, MSSIH_TOTAL_INDIV_CNT_IND))
# 
# tt.field.macro <- field.macro %>% 
#   mutate(SITE_ID = sub('_[^_]*$', '', EVENT_ID))
# 
# tt.field.eventinfo <- field.eventinfo %>% 
#   mutate(SITE_ID = sub('_[^_]*$', '', EVENT_SMAS_ID))
# 
# tt.field.habitat <- field.habitat %>% 
#   mutate(SITE_ID = sub('_[^_]*$', '', EVENT_SMAS_ID))
# 
# tt.sites.master <- sites.master %>% 
  

```

Load in all raw bug data and compile
```{r}
# bugs.path.16.17 <- file.path(root.dir, "data", "compile_2016-17", "LGSS_BUGS_2016_2017_IDSs_fixed.xlsx")
# bugs2016.df <- readxl::read_excel(bugs.path.16.17, sheet = "LGSS 2016")
# bugs2017.df <- readxl::read_excel(bugs.path.16.17, sheet = "LGSS 2017")
# bugs201617.df <-rbind(bugs2016.df,bugs2017.df) %>% 
#   mutate(BASIN = formatC(as.numeric(BASIN), width = 2, format = "d", flag = "0")) %>% 
#   mutate(RIVMILE = formatC(as.numeric(RIVMILE), format='f', digits=1 )) %>% 
#   mutate(SITE_ID = paste(BASIN,LOCATION,RIVMILE, sep = "-")) %>% 
#   mutate(COLL_DATE = as.Date(COLL_DATE, format="%m/%d/%Y"))
#   # mutate(YEAR = format(as.Date(COLL_DATE, format="%m/%d/%Y"),"%Y"))
# # bugs2016 <- bugs201617.df %>% 
# #   filter(YEAR == "2016")
# # bugs2017 <- bugs201617.df %>% 
# #   filter(YEAR == "2017")
# # rm(bugs2016, bugs2017)
# rm(bugs2016.df, bugs2017.df)

bugs.2018.1 <- read_xlsx(file.path(root.dir, "data", "2015-2019", "raw_macro_2018_2019",
                                   "2018_Lakes_RBS-Scr_RMN_T4T.xlsx"), col_types = c(Replicate="text")) %>% 
  rename(RIVMILE = RiverMile, SITE_ID = LOCATION) %>% 
  mutate(LOCATION = "") %>% 
  select(-"WAA Project ID")

bugs.2018.2 <- read_xlsx(file.path(root.dir, "data", "2015-2019", "raw_macro_2018_2019",
                                    "NYSDEC_MacroTaxa_WALK_RAS_2018.xlsx")) %>% 
  mutate(ClientProjectName = "") %>% 
  rename(SITE_ID = LOCATION) %>% 
  mutate(LOCATION = "") %>% 
  select(-"WAA Project ID")

bugs.2019 <- read_csv(file.path(root.dir, "data", "2015-2019", "raw_macro_2018_2019", "2019_MacroTaxa.csv"), col_types = c(Replicate="c")) %>% 
  rename(SITE_ID = SITE_LOC_ID) %>% 
  select("WAA ID", "BASIN", "SITE_ID", "RIVMILE", "COLL_DATE", "COLLECT", "Replicate", "MACRO_GENSPECIES", "INDIV", "Stage", "TAXONOMIST", "Comments", "#_Grids", "PercentWTSorted", "TotalInd", "ClientProjectName", "LOCATION")

bugs.bind.18.19 <- rbind(bugs.2018.1, bugs.2018.2, bugs.2019) %>% 
  filter(COLLECT %in% c("Low_Gradient", "Low Gradient", "9")) %>% 
  rename(REPLICATE = Replicate)

# Subset ITS table to LG and see if there are extras that didn't make it into 2015-19 data 
  # (may be 3 in 2017, 1 in 2016, and 5 in 2015)



```

Redo 2015-2017 merge from source (taken from "compile_2016-2017.Rmd")
```{r}
bugs.path <- file.path(root.dir,  "data", "compile_2016-17", "LGSS_BUGS_2016_2017_IDSs_fixed.xlsx")
bugs2016.df <- readxl::read_excel(bugs.path, sheet = "LGSS 2016")
bugs2017.df <- readxl::read_excel(bugs.path, sheet = "LGSS 2017")
bugs201617.df <-rbind(bugs2016.df,bugs2017.df)

#Format fields to add leading, and keep trailing zeros.
bugs201617.df$BASIN <- as.numeric(bugs201617.df$BASIN)
bugs201617.df$BASIN <- formatC(bugs201617.df$BASIN, width = 2, format = "d", flag = "0")
bugs201617.df$RIVMILE <- as.numeric(bugs201617.df$RIVMILE)
bugs201617.df$RIVMILE <- formatC( bugs201617.df$RIVMILE, format='f', digits=1 )

#Create BAS_LOC_RM field
bugs201617.df$SITE_ID <- paste0(bugs201617.df$BASIN,"-",bugs201617.df$LOCATION,"-",bugs201617.df$RIVMILE)

#Transform from long to wide
library(tidyverse)
bugmatrix1617.df <- bugs201617.df %>% 
  mutate(COLL_DATE = as.Date(COLL_DATE, format = "%m/%d/%Y")) %>% 
  dplyr::select(SITE_ID, COLL_DATE, REPLICATE, MACRO_GENSPECIES, INDIV) %>% 
  group_by(SITE_ID,COLL_DATE, REPLICATE, MACRO_GENSPECIES) %>% 
  summarise(INDIV = sum(INDIV)) %>% 
  # mutate(MACRO_GENSPECIES = str_replace_all(MACRO_GENSPECIES, " ", "_")) %>% 
  spread(MACRO_GENSPECIES, INDIV, fill = 0)

#Rename repeat site (already sampled in 2015)
# bugmatrix1617.df$BAS_LOC_RM <- gsub("07-HARB-0.5", "07-HARB-0.5_b",bugmatrix1617.df$BAS_LOC_RM)

# Bind 2015 w/ 2016-2017




```

Pull in 2015 field data to add dates and merge to the other years.
```{r}
fielddata.2015 <- readxl::read_excel(file.path(root.dir,  "data", 
                                               "2015_LGSS_alltables_fixed_Dec2018.xlsx"), sheet = "FieldData") %>% 
  rename(COLL_DATE = Date_FieldData) %>% 
  rename(SITE_ID = BAS_LOC_RM) %>% 
  mutate(COLL_DATE = as.Date(COLL_DATE)) %>% 
  select(SITE_ID, COLL_DATE)


bugmatrix2015.df <- read.csv(file.path(root.dir, "data", "2015_bugs.csv"), stringsAsFactors = FALSE, 
                             check.names = FALSE) %>% 
  rename(SITE_ID = BAS_LOC_RM) %>% 
  left_join(fielddata.2015, by = "SITE_ID") %>% 
  mutate(REPLICATE = 1) %>% 
  select(SITE_ID, COLL_DATE, REPLICATE, everything())

#Replace NAs with 0s
bugmatrix2015.df[is.na(bugmatrix2015.df)] <- 0
#Rename repeat site (also sampled in 2016-17 dataset)
# bugmatrix2015.df$BAS_LOC_RM <- gsub("07-HARB-0.5", "07-HARB-0.5_a",bugmatrix2015.df$BAS_LOC_RM)


LG_all_bugs.df <- bind_rows(bugmatrix2015.df, bugmatrix1617.df)
LG_all_bugs.df[is.na(LG_all_bugs.df)] <- 0
LG_all_bugs.df <- LG_all_bugs.df[order(LG_all_bugs.df$BAS_LOC_RM),] 

```


Merge tables to associate site info with field data.
```{r}
FSmerge <- merge(field_data,sites_tbl,by="BAS_LOC_RM", all=FALSE)

```

```{r}
write.table(FSmerge, file.path(root.dir, "data/compile_2016-17/LGSS_16-17_field-Sites_merge.csv"),sep=",", row.names = FALSE)

```

### For 2016-17 bug data (long format to matrix for PRIMER import) ###

Specify the file path to the XLS file.
```{r}
root.dir <- rprojroot::find_root("lgss.Rproj")

bugs.path <- file.path(root.dir,
                            "data",
                            "compile_2016-17",
                            "LGSS_BUGS_2016_2017_IDSs_fixed.xlsx")
```

Identify all of the sheets in the XLS file.
```{r}
sheet.vec <- readxl::excel_sheets(bugs.path)
```

Read in 2016 and 2017 bugs sheets (long format), bind, and create site ID field
```{r}
bugs2016.df <- readxl::read_excel(bugs.path, sheet = "LGSS 2016")
bugs2017.df <- readxl::read_excel(bugs.path, sheet = "LGSS 2017")

bugs201617.df <-rbind(bugs2016.df,bugs2017.df)

#Format fields to add leading, and keep trailing zeros.
bugs201617.df$BASIN <- as.numeric(bugs201617.df$BASIN)
bugs201617.df$BASIN <- formatC(bugs201617.df$BASIN, width = 2, format = "d", flag = "0")

bugs201617.df$RIVMILE <- as.numeric(bugs201617.df$RIVMILE)
bugs201617.df$RIVMILE <- formatC( bugs201617.df$RIVMILE, format='f', digits=1 )

#Create BAS_LOC_RM field
bugs201617.df$BAS_LOC_RM <- paste0(bugs201617.df$BASIN,"-",bugs201617.df$LOCATION,"-",bugs201617.df$RIVMILE)


```

Transform bugs from long to matrix
```{r}
library(tidyverse)
bugmatrix1617.df <- bugs201617.df %>% 
  dplyr::select(BAS_LOC_RM, MACRO_GENSPECIES, INDIV) %>% 
  group_by(BAS_LOC_RM, MACRO_GENSPECIES) %>% 
  summarise(INDIV = sum(INDIV)) %>% 
  # mutate(MACRO_GENSPECIES = str_replace_all(MACRO_GENSPECIES, " ", "_")) %>% 
  spread(MACRO_GENSPECIES, INDIV, fill = 0)

#Rename repeat site (already sampled in 2015)
bugmatrix1617.df$BAS_LOC_RM <- gsub("07-HARB-0.5", "07-HARB-0.5_b",bugmatrix1617.df$BAS_LOC_RM)

#Count total to check if >200
# bugmatrix1617.df$total <- rowSums(bugmatrix1617.df[,2:280])

#Replace spaces in column names to match 2015 data
# names(bugmatrix1617.df) <- gsub(x = names(bugmatrix1617.df), pattern = "\\ ", replacement = ".")
  
# write.table(bugmatrix1617.df, file.path(root.dir, "data/LG_2016-17_BUGS.csv"),sep=",", row.names = FALSE)


```

Bind 2015 bugs with 2016-17
```{r}
bugmatrix2015.df <- read.csv(file.path(root.dir, "data", "2015_bugs.csv"), stringsAsFactors = FALSE, check.names = FALSE)
#Replace NAs with 0s
bugmatrix2015.df[is.na(bugmatrix2015.df)] <- 0
#Rename repeat site (also sampled in 2016-17 dataset)
bugmatrix2015.df$BAS_LOC_RM <- gsub("07-HARB-0.5", "07-HARB-0.5_a",bugmatrix2015.df$BAS_LOC_RM)

LG_all_bugs.df <- dplyr::bind_rows(bugmatrix2015.df, bugmatrix1617.df)
LG_all_bugs.df[is.na(LG_all_bugs.df)] <- 0
LG_all_bugs.df <- LG_all_bugs.df[order(LG_all_bugs.df$BAS_LOC_RM),] 

write.table(LG_all_bugs.df, file.path(root.dir, "data/LG_ALL_BUGS.csv"),sep=",", row.names = FALSE)

```

Invesitgating why bind results in different number of taxa when converting spaces to decimals (line 98)... 
```{r}
# bugmatrix2015.df.chkFALSE <- read.csv(file.path(root.dir, "data", "2015_bugs.csv"), check.names = FALSE) %>% 
#   dplyr::bind_rows(bugmatrix1617.df)
# names(bugmatrix2015.df.chkFALSE) <- str_replace_all(names(bugmatrix2015.df.chkFALSE), " ", "_")
# 
# bugmatrix2015.df.chkTRUE <- read.csv(file.path(root.dir, "data", "2015_bugs.csv"), check.names = TRUE) %>% 
#     dplyr::bind_rows(bugmatrix1617.df)
# 
# 
# test <- data.frame(name = names(LG_all_bugs.df))
# test2 <- data.frame(name = names(bugmatrix2015.df))
# 
# anti.df <- anti_join(test, test2)
# 
# name!names(bugmatrix2015.df) %in% names(bugmatrix1617.df)
```

